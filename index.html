<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fitness Pro - Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* --- ENGINE --- */
        body { background-color: #f8fafc; color: #0f172a; overscroll-behavior: none; -webkit-tap-highlight-color: transparent; }
        
        .strip-gradient {
            background: linear-gradient(to bottom, #ef4444, #fbbf24, #2563eb, #ef4444);
            background-size: 100% 200%;
            animation: stripFlow 8s linear infinite;
            will-change: background-position;
            transform: translateZ(0);
        }
        @keyframes stripFlow { 0% { background-position: 0% 0%; } 100% { background-position: 0% 200%; } }

        .pro-card {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transform: translateZ(0);
        }
        
        .core-tile { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #e2e8f0; }
        .core-tile:active { transform: scale(0.95); }
        .core-tile.active { background: #dcfce7; border-color: #22c55e; color: #15803d; }

        .chart-dot { transition: r 0.2s ease; cursor: pointer; } 
        .chart-dot:hover { r: 6; stroke-width: 3; }
        
        /* Timeline */
        .history-item { position: relative; z-index: 1; }
        .history-line { position: absolute; left: 19px; top: 35px; bottom: -25px; width: 2px; background: #e2e8f0; z-index: 0; }
        .history-item:last-child .history-line { display: none; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        input:focus { outline: none; }
        * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    </style>
</head>
<body class="min-h-screen font-sans p-4 pb-32 select-none">

    <div class="flex items-center justify-between mb-6 pt-2">
        <div class="flex items-center gap-4">
            <div class="relative w-16 h-16 cursor-pointer group shrink-0" onclick="openProfileViewer()">
                <div class="w-full h-full rounded-full overflow-hidden border-2 border-white shadow-md relative bg-slate-200">
                    <img id="profileImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-full h-full object-cover">
                </div>
                <canvas id="resizeCanvas" class="hidden"></canvas>
                <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="processProfilePic(this)">
            </div>
            
            <div class="flex flex-col justify-center">
                <label class="text-[9px] font-black text-slate-400 tracking-[0.2em] leading-none mb-1">HELLO,</label>
                <input type="text" id="userNameInput" value="USER" onchange="saveData()" class="bg-transparent text-2xl font-black uppercase w-48 text-slate-900 border-none p-0 leading-none truncate focus:text-blue-600 transition-colors">
            </div>
        </div>
        
        <button onclick="openStatsModal()" class="w-10 h-10 bg-white rounded-xl shadow-sm border border-slate-200 flex items-center justify-center active:scale-95 text-slate-400 hover:text-blue-600">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        </button>
    </div>

    <div class="pro-card relative w-full rounded-2xl overflow-hidden mb-4 p-5 pl-7 shadow-sm">
        <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient"></div>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-[10px] font-black text-slate-400 tracking-widest uppercase">DAILY TARGETS</h3>
            <span class="text-[9px] font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg cursor-pointer hover:bg-blue-100 transition" onclick="openStatsModal()">CONFIGURE</span>
        </div>
        <div class="grid grid-cols-3 gap-3 text-center">
            <div class="bg-emerald-50/80 p-2.5 rounded-2xl border border-emerald-100"><div class="text-[9px] font-black text-emerald-600 mb-1 tracking-wider">LOSS</div><div id="calLoss" class="text-sm font-black text-slate-800">--</div></div>
            <div class="bg-blue-50/80 p-2.5 rounded-2xl border border-blue-100 scale-105 shadow-sm z-10"><div class="text-[9px] font-black text-blue-600 mb-1 tracking-wider">MAINTAIN</div><div id="calMaintain" class="text-lg font-black text-slate-800">--</div></div>
            <div class="bg-orange-50/80 p-2.5 rounded-2xl border border-orange-100"><div class="text-[9px] font-black text-orange-600 mb-1 tracking-wider">GAIN</div><div id="calGain" class="text-sm font-black text-slate-800">--</div></div>
        </div>
    </div>

    <div class="pro-card relative w-full rounded-2xl overflow-hidden mb-4 p-5 pl-7">
        <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient"></div>
        <div class="flex items-center justify-between">
            <div><p class="text-[10px] font-black text-slate-400 tracking-widest uppercase mb-1">Current Streak</p><div class="flex items-center gap-2"><span id="streakCount" class="text-5xl font-black italic text-slate-800">0</span><span class="text-3xl filter drop-shadow-sm">üèÜ</span></div></div>
            <div class="text-[9px] font-bold text-slate-400 text-right max-w-[80px] leading-tight">CONSISTENCY<br>IS THE ONLY<br>MAGIC</div>
        </div>
    </div>

    <div class="pro-card relative w-full rounded-2xl overflow-hidden mb-4 p-4 pl-6">
        <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient" style="filter: hue-rotate(90deg);"></div>
        <h3 class="text-[10px] font-black text-slate-400 tracking-widest uppercase mb-3">DAILY CORE</h3>
        <div class="grid grid-cols-4 gap-2">
            <div onclick="openCoreModal('pushup')" id="core-pushup" class="core-tile bg-slate-50 rounded-xl p-3 flex flex-col items-center justify-center cursor-pointer text-slate-400">
                <svg class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg><div class="text-[8px] font-bold">PUSH</div>
            </div>
            <div onclick="openCoreModal('pullup')" id="core-pullup" class="core-tile bg-slate-50 rounded-xl p-3 flex flex-col items-center justify-center cursor-pointer text-slate-400">
                <svg class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg><div class="text-[8px] font-bold">PULL</div>
            </div>
            <div onclick="openCoreModal('squat')" id="core-squat" class="core-tile bg-slate-50 rounded-xl p-3 flex flex-col items-center justify-center cursor-pointer text-slate-400">
                <svg class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg><div class="text-[8px] font-bold">LEGS</div>
            </div>
            <div onclick="openCoreModal('abs')" id="core-abs" class="core-tile bg-slate-50 rounded-xl p-3 flex flex-col items-center justify-center cursor-pointer text-slate-400">
                <svg class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" /></svg><div class="text-[8px] font-bold">ABS</div>
            </div>
        </div>
    </div>

    <div onclick="openGymModal()" class="pro-card relative w-full rounded-2xl overflow-hidden mb-4 active:scale-[0.99] transition-transform cursor-pointer">
        <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient"></div>
        <div class="p-5 pl-7 flex justify-between items-center">
            <div class="flex-1 pr-2"><h2 class="text-2xl font-black italic tracking-tighter uppercase text-slate-800 mb-2">Gym Workout</h2><div id="todayPreview" class="text-[10px] font-bold text-blue-700 uppercase tracking-widest bg-blue-50 border border-blue-100 px-3 py-1.5 rounded-lg inline-block"></div></div>
            <div class="relative w-16 h-16 shrink-0">
                <svg class="w-full h-full -rotate-90"><circle cx="32" cy="32" r="28" stroke="#e2e8f0" stroke-width="6" fill="transparent" /><circle id="circleRing" cx="32" cy="32" r="28" stroke="#3b82f6" stroke-width="6" fill="transparent" class="transition-all duration-700" stroke-dasharray="175" stroke-dashoffset="175" stroke-linecap="round"/></svg>
                <div class="absolute inset-0 flex items-center justify-center"><span id="gymPercent" class="text-xs font-black text-slate-800">0%</span></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="pro-card relative rounded-2xl overflow-hidden flex flex-col justify-between h-40">
            <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient"></div>
            <div class="p-4 pl-6 h-full flex flex-col justify-between"><div><span class="text-[9px] font-black tracking-widest uppercase text-slate-400 block mb-1">CARDIO</span><div class="flex items-baseline gap-0.5"><input type="number" id="cardioInput" value="0" onchange="updateVal('cardio', this.value)" class="bg-transparent w-full text-3xl font-black text-slate-800 border-none p-0 leading-none"><span class="text-[9px] text-slate-400 font-bold shrink-0 self-end mb-1">/ 30m</span></div></div><div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden"><div id="cardioBar" class="bg-blue-500 h-full w-0 transition-all duration-500"></div></div><button onclick="addVal('cardio', 5)" class="w-full py-2 bg-slate-800 rounded-lg text-[10px] font-bold uppercase text-white active:scale-95 transition-all">+ 5 MIN</button></div>
        </div>
        <div class="pro-card relative rounded-2xl overflow-hidden flex flex-col justify-between h-40">
            <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient"></div>
            <div class="p-4 pl-6 h-full flex flex-col justify-between"><div><span class="text-[9px] font-black tracking-widest uppercase text-slate-400 block mb-1">STEPS</span><div class="flex items-baseline gap-0.5"><input type="number" id="stepsInput" value="0" onchange="updateVal('steps', this.value)" class="bg-transparent w-full text-2xl font-black text-slate-800 border-none p-0 leading-none"><span class="text-[9px] text-slate-400 font-bold shrink-0 self-end mb-1">/ 10k</span></div></div><div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden"><div id="stepsBar" class="bg-green-500 h-full w-0 transition-all duration-500"></div></div><button onclick="addVal('steps', 1000)" class="w-full py-2 bg-slate-800 rounded-lg text-[10px] font-bold uppercase text-white active:scale-95 transition-all">+ 1000</button></div>
        </div>
    </div>

    <div onclick="openWeightModal()" class="pro-card relative w-full rounded-2xl overflow-hidden mb-4 p-5 pl-7 cursor-pointer active:scale-[0.99] transition-transform">
        <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient"></div>
        <div class="flex justify-between items-center">
            <div>
                <span class="text-[10px] font-black tracking-widest uppercase text-slate-400">BODY WEIGHT</span>
                <div class="flex items-baseline mt-1"><span id="displayWeight" class="text-3xl font-black text-slate-800 tracking-tighter">--</span><span class="text-xs font-bold text-slate-400 ml-1">KG</span></div>
                <div id="bmiDisplayMain" class="mt-2 text-[9px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded inline-block uppercase">BMI: --</div>
            </div>
            <div class="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center text-slate-400"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></div>
        </div>
    </div>

    <div id="profileViewModal" class="fixed inset-0 z-[70] bg-black/95 hidden items-center justify-center p-6 backdrop-blur-md">
        <div class="flex flex-col items-center w-full max-w-sm">
            <button onclick="document.getElementById('profileViewModal').classList.add('hidden'); document.getElementById('profileViewModal').classList.remove('flex')" class="absolute top-6 right-6 text-white/50 hover:text-white transition-colors"><svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <img id="profileImgLarge" src="" class="w-64 h-64 rounded-full object-cover border-4 border-white/20 shadow-2xl mb-10">
            <button onclick="document.getElementById('profileUpload').click()" class="bg-white text-black px-8 py-4 rounded-full font-black uppercase tracking-widest shadow-lg active:scale-95 transition-transform flex items-center gap-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>Edit Photo</button>
        </div>
    </div>

    <div id="weightModal" class="fixed inset-0 z-50 bg-[#f8fafc] hidden flex-col overflow-y-auto">
        <div class="p-6 flex justify-between items-center sticky top-0 bg-[#f8fafc] z-10 border-b border-slate-200 shadow-sm"><h2 class="text-lg font-black uppercase text-slate-800">Analysis</h2><button onclick="document.getElementById('weightModal').classList.add('hidden'); document.getElementById('weightModal').classList.remove('flex');" class="w-10 h-10 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center font-bold">‚úï</button></div>
        <div class="p-6 pb-20">
            <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-lg mb-6">
                <div class="flex justify-between items-end mb-4"><span class="text-[10px] font-bold text-slate-400">TREND (0-120 KG)</span><span id="modalCurrentWeight" class="text-xl font-black text-slate-800">-- KG</span></div>
                <div class="relative w-full h-48 border-l border-b border-slate-200 bg-slate-50/50">
                    <svg id="weightChart" class="w-full h-full overflow-visible" preserveAspectRatio="none">
                        <defs><linearGradient id="chartFill" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.3"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0"/></linearGradient></defs>
                        <path id="chartArea" d="" fill="url(#chartFill)" />
                        <path id="chartLine" d="" fill="none" stroke="#3b82f6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                        <g id="chartDots"></g>
                    </svg>
                </div>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 mb-6">
                <div class="flex gap-3 mb-3">
                    <div class="flex-1"><label class="text-[10px] font-bold text-slate-400 block mb-1">DATE</label><input type="date" id="weightDateInput" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3 font-bold"></div>
                    <div class="w-24"><label class="text-[10px] font-bold text-slate-400 block mb-1">KG</label><input type="number" id="newWeightInput" placeholder="0.0" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-3 font-black"></div>
                </div>
                <button onclick="logNewWeight()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold uppercase shadow-lg">LOG WEIGHT</button>
            </div>
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">HISTORY</h3>
            <div id="historyList" class="flex flex-col gap-0 relative pb-10"></div>
        </div>
    </div>

    <div id="workoutModal" class="fixed inset-0 z-50 bg-[#f8fafc] hidden flex-col overflow-y-auto pb-20">
        <div class="p-4 flex justify-between items-center sticky top-0 bg-[#f8fafc] z-10 border-b border-slate-200 shadow-sm"><div class="strip-gradient p-[2px] rounded-full"><div class="bg-white px-6 py-2 rounded-full"><span id="modalDay" class="text-sm font-black uppercase tracking-widest text-slate-800"></span></div></div><button onclick="closeModal()" class="w-10 h-10 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center font-bold active:scale-90">‚úï</button></div>
        <div class="p-4"><div id="modalTabs" class="flex gap-2 mb-6"></div><div id="modalExercises" class="flex flex-col gap-4"></div></div>
    </div>

    <div id="statsModal" class="fixed inset-0 z-50 bg-slate-900/50 hidden flex-col justify-center items-center p-6"><div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl"><h2 class="text-xl font-black text-slate-800 mb-4 uppercase">Stats</h2>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div><label class="text-[10px] font-bold text-slate-400 block mb-1">AGE</label><input type="number" id="ageInput" class="w-full bg-slate-100 rounded-lg p-2 font-bold"></div>
            <div><label class="text-[10px] font-bold text-slate-400 block mb-1">HEIGHT</label><input type="number" id="heightInput" class="w-full bg-slate-100 rounded-lg p-2 font-bold"></div>
        </div>
        <div class="mb-4"><label class="text-[10px] font-bold text-slate-400 block mb-1">REFERENCE WEIGHT (For Calories)</label><input type="number" id="statsWeightInput" class="w-full bg-slate-100 rounded-lg p-2 font-bold"></div>
        <div class="mb-4"><label class="text-[10px] font-bold text-slate-400 block mb-1">ACTIVITY</label><select id="activityInput" class="w-full bg-slate-100 rounded-lg p-2 font-bold"><option value="1.2">Sedentary</option><option value="1.375">Light</option><option value="1.55">Moderate</option><option value="1.725">Active</option></select></div><div class="flex gap-2 mb-4"><button id="btnMale" onclick="setGender('male')" class="flex-1 py-2 rounded font-bold">Male</button><button id="btnFemale" onclick="setGender('female')" class="flex-1 py-2 rounded font-bold">Female</button></div><button onclick="saveStats()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold uppercase">SAVE</button><button onclick="document.getElementById('statsModal').classList.remove('flex'); document.getElementById('statsModal').classList.add('hidden');" class="w-full mt-2 text-slate-400 font-bold text-xs py-2">CANCEL</button></div></div>

    <div id="deleteModal" class="fixed inset-0 z-[60] bg-black/50 hidden items-center justify-center"><div class="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full text-center"><h3 class="text-lg font-black text-slate-800 mb-4">Delete Entry?</h3><div class="flex gap-3"><button onclick="document.getElementById('deleteModal').classList.add('hidden'); document.getElementById('deleteModal').classList.remove('flex');" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">Cancel</button><button onclick="confirmDelete()" class="flex-1 py-3 bg-red-600 rounded-xl font-bold text-white">Delete</button></div></div></div>

    <script>
        // CONFIG
        const today = new Date();
        const days = ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
        const dayName = days[today.getDay()];
        const dateKey = today.toLocaleDateString(); 

        const workouts = {
            'MONDAY': { tabs: ['Chest', 'Triceps'], ex: [['Bench Press', 'Incline Press', 'Chest Fly', 'Dips', 'Cables'], ['Skullcrushers', 'Rope Pushdown', 'Overhead Ext', 'Close Grip', 'Machine Dip']] },
            'TUESDAY': { tabs: ['Back', 'Biceps'], ex: [['Lat Pulldown', 'Cable Row', 'T-Bar', 'Deadlift', 'Single Arm Row'], ['Barbell Curl', 'Hammer Curl', 'Preacher Curl', 'Cable Curl', 'Conc. Curl']] },
            'WEDNESDAY': { tabs: ['Legs', 'Shoulders'], ex: [['Leg Press', 'Hack Squat', 'Extensions', 'Leg Curls', 'Calf Raise'], ['Overhead Press', 'Lat Raise', 'Front Raise', 'Rear Delt', 'Shrugs']] },
            'THURSDAY': { tabs: ['Chest Var', 'Triceps Var'], ex: [['DB Bench', 'Hammer Incline', 'Low Fly', 'Smith Press', 'Decline'], ['V-Bar', 'French Press', 'Kickbacks', 'Rev Grip', 'Single Ext']] },
            'FRIDAY': { tabs: ['Back Var', 'Biceps Var'], ex: [['Rev Pulldown', 'Bent Row', 'Meadows', 'Rack Pull', 'Straight Arm'], ['Inc Curl', 'Spider', 'Zottman', 'EZ Curl', 'Bayesian']] },
            'SATURDAY': { tabs: ['Legs Var', 'Shoulders Var'], ex: [['Goblet Squat', 'RDL', 'Split Squat', 'Hip Thrust', 'Seated Calf'], ['Arnold Press', 'Cable Lat', 'Face Pull', 'Upright Row', 'Machine Press']] },
            'SUNDAY': { tabs: ['Rest', 'Recovery'], ex: [[], []] }
        };
        const coreExercises = ['Pushups', 'Pullups', 'Squats', 'Abs'];

        // STATE
        let currentTab = 0, cardioVal = 0, stepsVal = 0, streak = 0, streakLocked = false;
        let userName = "USER", profilePic = "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix";
        let stats = { age: 25, height: 175, gender: 'male', activity: 1.55, weight: 75.0 }; // Added weight to stats for calc
        let exerciseData = {}; weightHistory = []; deleteIndex = -1; isCoreMode = false;

        function init() {
            loadData();
            document.getElementById('todayPreview').innerText = workouts[dayName].tabs.length ? `${workouts[dayName].tabs[0]} & ${workouts[dayName].tabs[1]}` : "REST";
            document.getElementById('userNameInput').value = userName;
            document.getElementById('profileImg').src = profilePic;
            document.getElementById('ageInput').value = stats.age;
            document.getElementById('heightInput').value = stats.height;
            document.getElementById('activityInput').value = stats.activity;
            document.getElementById('statsWeightInput').value = stats.weight; // Set independent weight
            updateGenderUI();
            document.getElementById('weightDateInput').valueAsDate = new Date();

            updateVal('cardio', cardioVal, false);
            updateVal('steps', stepsVal, false);
            calcTotalProgress();
            checkCoreStatus();
            refreshWeightUI();
        }

        function saveData() {
            const data = { date: dateKey, user: document.getElementById('userNameInput').value, cardio: cardioVal, steps: stepsVal, profilePic: profilePic, stats: stats, exerciseData: exerciseData, weightHistory: weightHistory, streak: streak, streakLocked: streakLocked };
            try { localStorage.setItem('fitnessProFinal', JSON.stringify(data)); } catch(e) {}
        }

        function loadData() {
            const raw = localStorage.getItem('fitnessProFinal');
            if(raw) {
                const data = JSON.parse(raw);
                userName = data.user || "USER"; profilePic = data.profilePic || "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix"; 
                stats = data.stats || { age: 25, height: 175, gender: 'male', activity: 1.55, weight: 75.0 }; 
                exerciseData = data.exerciseData || {}; weightHistory = data.weightHistory || []; streak = data.streak || 0;
                
                // Init weight history if needed
                if(weightHistory.length === 0 && stats.weight) weightHistory.push({date: Date.now(), weight: parseFloat(stats.weight)});
                
                if(data.date === dateKey) { cardioVal = data.cardio || 0; stepsVal = data.steps || 0; streakLocked = data.streakLocked || false; }
                else { cardioVal = 0; stepsVal = 0; streakLocked = false; saveData(); }
            }
        }

        function processProfilePic(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.getElementById('resizeCanvas'); const ctx = canvas.getContext('2d'); const maxSize = 200; let w = img.width; let h = img.height;
                        if (w > h) { if (w > maxSize) { h *= maxSize / w; w = maxSize; } } else { if (h > maxSize) { w *= maxSize / h; h = maxSize; } }
                        canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                        profilePic = canvas.toDataURL('image/jpeg', 0.85); document.getElementById('profileImg').src = profilePic; saveData();
                        document.getElementById('profileViewModal').classList.remove('flex'); document.getElementById('profileViewModal').classList.add('hidden');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- CORE UI ---
        function checkCoreStatus() {
            coreExercises.forEach(ex => {
                const id = 'core-' + ex.split('/')[0].toLowerCase();
                const el = document.getElementById(id);
                if(el && exerciseData[dateKey] && exerciseData[dateKey][ex] && exerciseData[dateKey][ex].completed) el.classList.add('active');
                else if(el) el.classList.remove('active');
            });
        }

        // --- WORKOUT ---
        function renderExercises(list) {
            const container = document.getElementById('modalExercises'); container.innerHTML = "";
            list.forEach((exName) => {
                const dayData = exerciseData[dateKey] || {};
                const ex = dayData[exName] || { sets: [{w:'',r:''}, {w:'',r:''}, {w:'',r:''}], completed: false };
                let setsHTML = '';
                for(let i=0; i<3; i++) { setsHTML += `<div class="flex items-center gap-3 mb-2"><span class="text-[10px] font-bold text-slate-400 w-6">SET ${i+1}</span><div class="flex items-center flex-1 bg-slate-50 border border-slate-200 rounded-lg overflow-hidden"><input type="number" placeholder="KG" value="${ex.sets[i].w}" oninput="logSet('${exName}', ${i}, 'w', this.value)" class="w-1/2 p-2 text-center text-sm font-bold bg-transparent border-r border-slate-200"><input type="number" placeholder="REPS" value="${ex.sets[i].r}" oninput="logSet('${exName}', ${i}, 'r', this.value)" class="w-1/2 p-2 text-center text-sm font-bold bg-transparent"></div></div>`; }
                const card = document.createElement('div'); card.className = "pro-card p-5 rounded-2xl relative overflow-hidden";
                if(ex.completed) card.style.borderColor = "#4ade80"; 
                card.innerHTML = `<div class="flex justify-between items-start mb-4"><div><h4 class="font-black text-slate-800 text-lg uppercase">${exName}</h4><div id="compare-${exName.replace(/[\s\/]/g, '')}" class="text-[10px] font-bold text-blue-500 mt-1 cursor-pointer bg-blue-50 px-2 py-1 rounded w-fit" onclick="showHistory('${exName}')">COMPARE PREV</div></div><div class="cursor-pointer transition-transform active:scale-90" onclick="toggleExerciseComplete('${exName}')"><div class="w-10 h-10 rounded-full flex items-center justify-center border-2 ${ex.completed ? 'bg-green-500 border-green-500' : 'bg-slate-50 border-slate-300'} transition-colors"><svg class="w-6 h-6 text-white ${ex.completed ? 'opacity-100' : 'opacity-0'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div></div></div>${setsHTML}`;
                container.appendChild(card);
            });
        }

        function logSet(exName, setIdx, field, val) {
            if(!exerciseData[dateKey]) exerciseData[dateKey] = {};
            if(!exerciseData[dateKey][exName]) exerciseData[dateKey][exName] = { sets: [{w:'',r:''}, {w:'',r:''}, {w:'',r:''}], completed: false };
            exerciseData[dateKey][exName].sets[setIdx][field] = val;
            if(val) { if(!exerciseData.history) exerciseData.history = {}; exerciseData.history[exName] = JSON.parse(JSON.stringify(exerciseData[dateKey][exName].sets)); }
            saveData();
        }

        function showHistory(exName) {
            const target = document.getElementById(`compare-${exName.replace(/[\s\/]/g, '')}`);
            const hist = exerciseData.history ? exerciseData.history[exName] : null;
            if(hist && Array.isArray(hist)) { const txt = hist.map(s => (s.w && s.r) ? `${s.w}x${s.r}` : '').filter(Boolean).join(' | '); target.innerText = txt || "No Data"; } else { target.innerText = "No Prev Data"; }
        }

        function toggleExerciseComplete(exName) {
            if(!exerciseData[dateKey]) exerciseData[dateKey] = {};
            if(!exerciseData[dateKey][exName]) exerciseData[dateKey][exName] = { sets: [{w:'',r:''}, {w:'',r:''}, {w:'',r:''}], completed: false };
            const newState = !exerciseData[dateKey][exName].completed;
            exerciseData[dateKey][exName].completed = newState;
            if(newState) { if(navigator.vibrate) navigator.vibrate(50); confetti({ particleCount: 80, spread: 80, origin: { y: 0.6 }, colors: ['#FFD700', '#FF1493'] }); }
            saveData();
            if(isCoreMode) { renderExercises(coreExercises); checkCoreStatus(); } else { renderExercises(workouts[dayName].ex[currentTab]); calcTotalProgress(); }
        }

        function calcTotalProgress() {
            if(!exerciseData[dateKey]) { updateCircle(0); return; }
            let total = 0, done = 0;
            const w = workouts[dayName]; if(!w.ex[0]) return;
            const allEx = [...w.ex[0], ...w.ex[1]];
            allEx.forEach(ex => { total++; if(exerciseData[dateKey][ex] && exerciseData[dateKey][ex].completed) done++; });
            const pct = total === 0 ? 0 : Math.round((done / total) * 100);
            updateCircle(pct);
            if(done === total && total > 0 && !streakLocked) { streak++; streakLocked = true; saveData(); }
            document.getElementById('streakCount').innerText = streak;
        }

        function updateCircle(pct) { document.getElementById('circleRing').style.strokeDashoffset = 175 - (175 * pct / 100); document.getElementById('gymPercent').innerText = pct + "%"; }

        // --- WEIGHT & CHART ---
        function openWeightModal() { document.getElementById('weightModal').classList.remove('hidden'); document.getElementById('weightModal').classList.add('flex'); requestAnimationFrame(renderChart); }
        function logNewWeight() {
            const wInput = document.getElementById('newWeightInput'), dInput = document.getElementById('weightDateInput');
            const val = parseFloat(wInput.value); if(!val) return;
            
            // Fix sorting order by using proper timestamp from date input
            const date = new Date(dInput.value); date.setHours(12,0,0,0);
            weightHistory.push({date: date.getTime(), weight: val});
            // Sort by date Descending for list (Newest top)
            // Sort by date Ascending for Graph
            
            // Sync to stats for calculator
            stats.weight = val;
            
            saveData(); 
            refreshWeightUI(); 
            wInput.value = "";
        }
        
        function refreshWeightUI() {
            if(weightHistory.length === 0) return;
            // Sort history for latest check
            const sortedByDate = [...weightHistory].sort((a,b) => a.date - b.date);
            const latest = sortedByDate[sortedByDate.length-1].weight;
            
            document.getElementById('displayWeight').innerText = latest;
            document.getElementById('modalCurrentWeight').innerText = latest + " KG";
            
            // BMI
            const h = stats.height / 100; const bmi = (latest / (h*h)).toFixed(1);
            let color = bmi < 25 ? "bg-green-100 text-green-600" : "bg-orange-100 text-orange-600";
            document.getElementById('bmiDisplayMain').innerText = `BMI: ${bmi}`;
            document.getElementById('bmiDisplayMain').className = `mt-2 text-[9px] font-bold px-2 py-0.5 rounded inline-block uppercase ${color}`;
            
            calculateCalories();
            renderChart(); renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('historyList'); list.innerHTML = "";
            // Descending order for display (Newest First)
            const sorted = [...weightHistory].sort((a,b) => b.date - a.date);
            
            sorted.forEach((item) => {
                const idx = weightHistory.indexOf(item); // Original index for deletion
                const d = new Date(item.date).toLocaleDateString('en-US', {month:'short', day:'numeric'});
                list.innerHTML += `<div class="history-item relative pl-8 pb-4"><div class="history-line"></div><div class="absolute left-2 top-[28px] w-2.5 h-2.5 rounded-full bg-blue-400 ring-4 ring-white z-10"></div><div class="pro-card p-3 rounded-2xl flex justify-between items-center transition-colors hover:bg-slate-50"><span class="text-xs font-bold text-slate-500 tracking-wide">${d}</span><div class="flex items-center gap-3"><span class="text-lg font-black text-slate-800">${item.weight} <span class="text-xs text-slate-400">KG</span></span><button onclick="requestDelete(${idx})" class="w-8 h-8 flex items-center justify-center text-red-400 bg-red-50 rounded-full hover:bg-red-500 hover:text-white transition-all active:scale-90">‚úï</button></div></div></div>`;
            });
        }
        
        function requestDelete(idx) { deleteIndex = idx; document.getElementById('deleteModal').classList.remove('hidden'); document.getElementById('deleteModal').classList.add('flex'); }
        function confirmDelete() { if(deleteIndex > -1) { weightHistory.splice(deleteIndex, 1); saveData(); refreshWeightUI(); } document.getElementById('deleteModal').classList.add('hidden'); document.getElementById('deleteModal').classList.remove('flex'); }

        function renderChart() {
            const svg = document.getElementById('weightChart'); if(weightHistory.length < 2) return;
            const w = svg.clientWidth, h = svg.clientHeight;
            // Ascending for Graph (Oldest -> Newest)
            const sorted = [...weightHistory].sort((a,b) => a.date - b.date);
            const pts = sorted.map((d, i) => { const x = (i/(sorted.length-1))*w; const y = h - (Math.min(d.weight, 120)/120)*h; return `${x},${y}`; });
            document.getElementById('chartLine').setAttribute('d', `M ${pts.join(' L ')}`);
            document.getElementById('chartArea').setAttribute('d', `M ${pts.join(' L ')} L ${w} ${h} L 0 ${h} Z`);
        }

        // --- STATS ---
        function setGender(g) { stats.gender = g; updateGenderUI(); }
        function updateGenderUI() { const m = document.getElementById('btnMale'), f = document.getElementById('btnFemale'); const active = "bg-blue-600 text-white shadow-md"; const inactive = "bg-slate-100 text-slate-400"; if(stats.gender === 'male') { m.className = `flex-1 py-2 rounded font-bold ${active}`; f.className = `flex-1 py-2 rounded font-bold ${inactive}`; } else { f.className = `flex-1 py-2 rounded font-bold ${active}`; m.className = `flex-1 py-2 rounded font-bold ${inactive}`; } }
        function openStatsModal() { document.getElementById('statsModal').classList.remove('hidden'); document.getElementById('statsModal').classList.add('flex'); setGender(stats.gender); }
        
        function saveStats() { 
            stats.age = parseFloat(document.getElementById('ageInput').value) || 25; 
            stats.height = parseFloat(document.getElementById('heightInput').value) || 175; 
            stats.activity = parseFloat(document.getElementById('activityInput').value) || 1.55;
            // Independent weight from stats modal
            stats.weight = parseFloat(document.getElementById('statsWeightInput').value) || stats.weight;
            
            saveData(); 
            document.getElementById('statsModal').classList.remove('flex'); 
            document.getElementById('statsModal').classList.add('hidden'); 
            calculateCalories();
        }

        function calculateCalories() {
            const w = stats.weight || 75; // Use the stats weight reference
            let offset = stats.gender === 'male' ? 5 : -161;
            let bmr = (10*w) + (6.25*stats.height) - (5*stats.age) + offset;
            const tdee = Math.round(bmr * stats.activity);
            
            document.getElementById('calMaintain').innerText = tdee; 
            document.getElementById('calLoss').innerText = tdee - 500; 
            document.getElementById('calGain').innerText = tdee + 300;
        }

        // --- MODAL & TABS ---
        function openGymModal() {
            isCoreMode = false;
            document.getElementById('modalDay').innerText = dayName;
            document.getElementById('modalTabs').classList.remove('hidden');
            const w = workouts[dayName];
            if(w.tabs.length) {
                document.getElementById('modalTabs').innerHTML = w.tabs.map((t, i) => `<button onclick="switchTab(${i})" class="flex-1 py-3 rounded-lg text-xs font-black uppercase tracking-widest transition-all ${currentTab === i ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-200 text-slate-500'}">${t}</button>`).join('');
                renderExercises(w.ex[currentTab]);
            } else { document.getElementById('modalExercises').innerHTML = "REST DAY"; }
            document.getElementById('workoutModal').classList.remove('hidden'); document.getElementById('workoutModal').classList.add('flex');
        }

        function openCoreModal(type) {
            isCoreMode = true;
            document.getElementById('modalDay').innerText = "DAILY CORE";
            document.getElementById('modalTabs').classList.add('hidden');
            renderExercises(coreExercises);
            document.getElementById('workoutModal').classList.remove('hidden'); document.getElementById('workoutModal').classList.add('flex');
        }

        function openProfileViewer() { document.getElementById('profileViewModal').classList.remove('hidden'); document.getElementById('profileViewModal').classList.add('flex'); }
        function closeModal() { document.getElementById('workoutModal').classList.add('hidden'); document.getElementById('workoutModal').classList.remove('flex'); }
        function switchTab(i) { currentTab = i; const w = workouts[dayName]; renderExercises(w.ex[currentTab]); const btns = document.getElementById('modalTabs').children; for(let b of btns) b.className = "flex-1 py-3 rounded-lg text-xs font-black uppercase tracking-widest transition-all bg-slate-200 text-slate-500"; btns[i].className = "flex-1 py-3 rounded-lg text-xs font-black uppercase tracking-widest transition-all bg-blue-600 text-white shadow-md"; }
        function updateVal(type, val, save=true) { let v = parseInt(val), max = type === 'cardio' ? 30 : 10000; if(v > max) v = max; if(v < 0) v = 0; if(type === 'cardio') cardioVal = v; if(type === 'steps') stepsVal = v; document.getElementById(`${type}Input`).value = v; document.getElementById(`${type}Bar`).style.width = (v / max * 100) + '%'; if(save) saveData(); }
        function addVal(type, amt) { let curr = parseInt(document.getElementById(`${type}Input`).value); updateVal(type, curr + amt); }

        init();
    </script>
</body>
</html>

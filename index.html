<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fitness Pro - Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* --- ENGINE --- */
        body { background-color: #f8fafc; color: #0f172a; overscroll-behavior: none; -webkit-tap-highlight-color: transparent; }
        
        .strip-gradient {
            background: linear-gradient(to bottom, #ef4444, #fbbf24, #2563eb, #ef4444);
            background-size: 100% 200%;
            animation: stripFlow 8s linear infinite;
            will-change: background-position;
            transform: translateZ(0);
        }
        @keyframes stripFlow { 0% { background-position: 0% 0%; } 100% { background-position: 0% 200%; } }

        .pro-card {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transform: translateZ(0);
        }
        
        /* --- ABS LEVELS STYLING --- */
        .grad-beginner { background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%); }
        .grad-intermediate { background: linear-gradient(135deg, rgba(249, 115, 22, 0.9) 0%, rgba(234, 88, 12, 0.9) 100%); }
        .grad-advanced { background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.9) 100%); }

        /* Shine Animation */
        .shine-effect::after {
            content: '';
            position: absolute;
            top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg);
            animation: shineMove 3s infinite;
        }
        @keyframes shineMove { 100% { left: 200%; } }

        /* Glassmorphism Class */
        .glass-purple-active {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.95), rgba(167, 139, 250, 0.9));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 8px 32px 0 rgba(124, 58, 237, 0.3);
        }

        /* --- TIMER ANIMATIONS --- */
        .bouncing-black-bg {
            background: linear-gradient(45deg, rgba(0,0,0,0.92), rgba(20,20,20,0.98), rgba(0,0,0,0.92));
            background-size: 200% 200%;
            animation: bounceBg 6s ease infinite;
            backdrop-filter: blur(15px);
        }
        @keyframes bounceBg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .color-cycle { animation: hueRotate 3s infinite linear; }
        @keyframes hueRotate { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        .text-shine-anim {
            background: linear-gradient(to right, #fff 20%, #a78bfa 50%, #fff 80%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: textShine 5s infinite linear;
        }
        @keyframes textShine {
            0% { background-position: 200% center; }
            30% { background-position: -200% center; }
            100% { background-position: -200% center; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        input:focus { outline: none; }
        * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    </style>
</head>
<body class="min-h-screen font-sans p-4 pb-32 select-none">

    <div class="flex items-center justify-between mb-6 pt-4 px-1">
        <div class="flex flex-col justify-center">
            <label class="text-[9px] font-black text-slate-400 tracking-[0.2em] leading-none mb-1">HELLO,</label>
            <input type="text" id="userNameInput" value="USER" onchange="saveData()" class="bg-transparent text-3xl font-black uppercase w-48 text-slate-900 border-none p-0 leading-none truncate focus:text-blue-600 transition-colors">
        </div>
        <div class="flex items-center gap-3">
            <button onclick="openHistoryModal()" class="group relative w-10 h-10 bg-white rounded-xl shadow-sm border border-slate-200 flex items-center justify-center active:scale-95 transition-all overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-tr from-indigo-500 to-purple-500 opacity-0 group-hover:opacity-10 transition-opacity"></div>
                <svg class="w-5 h-5 text-slate-400 group-hover:text-indigo-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
            </button>
            
            <button onclick="openTutorialModal()" class="group w-10 h-10 bg-white rounded-xl shadow-sm border border-slate-200 flex items-center justify-center active:scale-95 hover:text-blue-600 transition-colors">
                <svg class="w-5 h-5 text-slate-400 group-hover:text-blue-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>

            <button onclick="openStatsModal()" class="group w-10 h-10 bg-white rounded-xl shadow-sm border border-slate-200 flex items-center justify-center active:scale-95 hover:text-blue-600 transition-colors">
                <svg class="w-5 h-5 text-slate-400 group-hover:text-blue-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </div>
    </div>

    <div class="pro-card relative w-full rounded-2xl overflow-hidden mb-4 p-5 pl-7 shadow-sm">
        <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient"></div>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-[10px] font-black text-slate-400 tracking-widest uppercase">DAILY TARGETS</h3>
            <span class="text-[9px] font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg cursor-pointer hover:bg-blue-100 transition" onclick="openStatsModal()">CONFIGURE</span>
        </div>
        <div class="grid grid-cols-3 gap-3 text-center">
            <div class="bg-emerald-50/80 p-2.5 rounded-2xl border border-emerald-100"><div class="text-[9px] font-black text-emerald-600 mb-1 tracking-wider">LOSS</div><div id="calLoss" class="text-sm font-black text-slate-800">--</div></div>
            <div class="bg-blue-50/80 p-2.5 rounded-2xl border border-blue-100 scale-105 shadow-sm z-10"><div class="text-[9px] font-black text-blue-600 mb-1 tracking-wider">MAINTAIN</div><div id="calMaintain" class="text-lg font-black text-slate-800">--</div></div>
            <div class="bg-orange-50/80 p-2.5 rounded-2xl border border-orange-100"><div class="text-[9px] font-black text-orange-600 mb-1 tracking-wider">GAIN</div><div id="calGain" class="text-sm font-black text-slate-800">--</div></div>
        </div>
    </div>

    <div class="pro-card relative w-full rounded-2xl overflow-hidden mb-4 p-5 pl-7">
        <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient"></div>
        <div class="flex items-center justify-between">
            <div><p class="text-[10px] font-black text-slate-400 tracking-widest uppercase mb-1">Current Streak</p><div class="flex items-center gap-2"><span id="streakCount" class="text-5xl font-black italic text-slate-800">0</span><span class="text-3xl filter drop-shadow-sm">üèÜ</span></div></div>
            <div class="text-[9px] font-bold text-slate-400 text-right max-w-[80px] leading-tight">CONSISTENCY<br>IS THE ONLY<br>MAGIC</div>
        </div>
    </div>

    <div onclick="openGymModal()" class="pro-card relative w-full rounded-2xl overflow-hidden mb-4 active:scale-[0.99] transition-transform cursor-pointer">
        <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient"></div>
        <div class="p-5 pl-7 flex justify-between items-center">
            <div class="flex-1 pr-2"><h2 class="text-2xl font-black italic tracking-tighter uppercase text-slate-800 mb-2">Gym Workout</h2><div id="todayPreview" class="text-[10px] font-bold text-blue-700 uppercase tracking-widest bg-blue-50 border border-blue-100 px-3 py-1.5 rounded-lg inline-block"></div></div>
            <div class="relative w-16 h-16 shrink-0">
                <svg class="w-full h-full -rotate-90">
                    <defs><linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#3b82f6" /><stop offset="100%" stop-color="#8b5cf6" /></linearGradient></defs>
                    <circle cx="32" cy="32" r="28" stroke="#e2e8f0" stroke-width="6" fill="transparent" />
                    <circle id="circleRing" cx="32" cy="32" r="28" stroke="url(#progressGradient)" stroke-width="6" fill="transparent" class="transition-all duration-700" stroke-dasharray="175" stroke-dashoffset="175" stroke-linecap="round"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center"><span id="gymPercent" class="text-xs font-black text-slate-800">0%</span></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4">
        <div onclick="openCoreModal('general')" class="pro-card relative rounded-2xl overflow-hidden flex flex-col justify-between h-36 cursor-pointer active:scale-95 transition-all">
            <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient" style="filter: hue-rotate(90deg);"></div>
            <div class="p-4 pl-6 h-full flex flex-col justify-between">
                <div><span class="text-[10px] font-black tracking-widest uppercase text-slate-400 block mb-1">DAILY</span><span class="text-2xl font-black text-slate-800">CORE</span></div>
                <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div id="coreProgressBar" class="bg-purple-500 h-full w-0 transition-all duration-500"></div></div>
                <div class="flex items-center gap-1 text-[9px] font-bold text-slate-400"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>3 EXERCISES</div>
            </div>
        </div>

        <div onclick="openCoreModal('abs')" class="pro-card relative rounded-2xl overflow-hidden flex flex-col justify-between h-36 cursor-pointer active:scale-95 transition-all">
            <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient" style="filter: hue-rotate(45deg);"></div>
            <div class="p-4 pl-6 h-full flex flex-col justify-between">
                <div><span class="text-[10px] font-black tracking-widest uppercase text-slate-400 block mb-1">TRAINING</span><span class="text-2xl font-black text-slate-800">ABS</span></div>
                <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div id="absProgressBar" class="bg-pink-500 h-full w-0 transition-all duration-500"></div></div>
                <div class="flex items-center gap-1 text-[9px] font-bold text-slate-400"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>LEVELS</div>
            </div>
        </div>
    </div>

    <div onclick="openWeightModal()" class="pro-card relative w-full rounded-2xl overflow-hidden mb-4 p-5 pl-7 cursor-pointer active:scale-[0.99] transition-transform">
        <div class="absolute left-0 top-0 bottom-0 w-2 strip-gradient"></div>
        <div class="flex justify-between items-center">
            <div>
                <span class="text-[10px] font-black tracking-widest uppercase text-slate-400">BODY WEIGHT</span>
                <div class="flex items-baseline mt-1"><span id="displayWeight" class="text-3xl font-black text-slate-800 tracking-tighter">--</span><span class="text-xs font-bold text-slate-400 ml-1">KG</span></div>
                <div id="bmiDisplayMain" class="mt-2 text-[9px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded inline-block uppercase">BMI: --</div>
            </div>
            <div class="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center text-slate-400"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></div>
        </div>
    </div>

    <div id="fullscreenTimer" class="fixed inset-0 z-[100] hidden flex-col items-center justify-center cursor-default bouncing-black-bg">
        
        <div class="absolute top-1/4 w-full text-center z-20 px-4 -mt-10">
            <h2 id="timerTitle" class="text-4xl font-black text-white tracking-widest uppercase drop-shadow-2xl animate-pulse">
                RESTING
            </h2>
        </div>

        <div id="restSelector" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-xs flex-col gap-4 z-30">
             <button onclick="startTimerInterval(30, 'RESTING'); hideRestSelector()" class="bg-white/10 backdrop-blur-md border border-white/20 text-white font-black text-xl py-4 rounded-2xl hover:bg-white/20 transition-all active:scale-95">30s</button>
             <button onclick="startTimerInterval(60, 'RESTING'); hideRestSelector()" class="bg-white/10 backdrop-blur-md border border-white/20 text-white font-black text-xl py-4 rounded-2xl hover:bg-white/20 transition-all active:scale-95">1m</button>
             <button onclick="startTimerInterval(90, 'RESTING'); hideRestSelector()" class="bg-white/10 backdrop-blur-md border border-white/20 text-white font-black text-xl py-4 rounded-2xl hover:bg-white/20 transition-all active:scale-95">1m 30s</button>
             <button onclick="startTimerInterval(120, 'RESTING'); hideRestSelector()" class="bg-white/10 backdrop-blur-md border border-white/20 text-white font-black text-xl py-4 rounded-2xl hover:bg-white/20 transition-all active:scale-95">2m</button>
        </div>

        <button onclick="resetTimer()" class="absolute top-8 right-8 w-12 h-12 bg-white/10 rounded-full backdrop-blur-md border border-white/20 flex items-center justify-center active:scale-90 transition-transform z-50 shadow-lg group">
            <svg class="w-6 h-6 text-white/80 group-hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>

        <div id="timerContainer" class="relative w-80 h-80 flex items-center justify-center hidden">
            <svg class="w-full h-full absolute inset-0" style="transform: rotate(-90deg);">
                <circle cx="160" cy="160" r="140" stroke="rgba(255,255,255,0.05)" stroke-width="8" fill="transparent" />
                
                <defs>
                    <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#22d3ee" /> <stop offset="50%" stop-color="#c084fc" /> <stop offset="100%" stop-color="#f472b6" /> </linearGradient>
                </defs>

                <circle id="timerProgressRing" class="color-cycle" cx="160" cy="160" r="140" stroke="url(#timerGradient)" stroke-width="8" fill="transparent" stroke-dasharray="880" stroke-dashoffset="0" stroke-linecap="round" />
            </svg>
            
            <span id="overlayTimerDisplay" class="text-8xl font-black text-white tracking-tighter drop-shadow-2xl text-shine-anim relative z-10">00:00</span>
        </div>
    </div>

    <div id="tutorialModal" class="fixed inset-0 z-50 bg-[#f8fafc] hidden flex-col justify-center items-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl border border-slate-100 relative">
            <button onclick="document.getElementById('tutorialModal').classList.remove('flex'); document.getElementById('tutorialModal').classList.add('hidden');" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center font-bold">‚úï</button>
            
            <h2 class="text-xl font-black text-slate-800 mb-6 uppercase tracking-wider text-center">‡§Æ‡§¶‡§§ (Help)</h2>
            
            <div class="flex flex-col gap-6">
                <div class="flex gap-4">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-black shrink-0">1</div>
                    <div>
                        <h3 class="font-bold text-slate-800 mb-1">‡§Ü‡§ú‡§ö‡§æ ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ</h3>
                        <p class="text-xs text-slate-500 leading-relaxed">‡§π‡•ã‡§Æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§µ‡§∞ <span class="font-bold text-blue-600">'Gym Workout'</span> ‡§ï‡§æ‡§∞‡•ç‡§°‡§µ‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§æ. ‡§§‡§ø‡§•‡•á ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§≤‡§æ ‡§Ü‡§ú‡§ö‡•á ‡§∏‡§∞‡•ç‡§µ ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§¶‡§ø‡§∏‡§§‡•Ä‡§≤.</p>
                    </div>
                </div>

                <div class="flex gap-4">
                    <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-black shrink-0">2</div>
                    <div>
                        <h3 class="font-bold text-slate-800 mb-1">‡§∏‡•á‡§ü ‡§ç‡§° ‡§ï‡§∞‡§£‡•á</h3>
                        <p class="text-xs text-slate-500 leading-relaxed">‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§ñ‡§æ‡§≤‡•Ä ‡§µ‡§ú‡§® (KG) ‡§Ü‡§£‡§ø ‡§∞‡•á‡§™‡•ç‡§∏ (Reps) ‡§ü‡§æ‡§ï‡§æ. ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ù‡§æ‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§¨‡§æ‡§ú‡•Ç‡§ö‡•ç‡§Ø‡§æ <span class="font-bold text-green-600">‡§ó‡•ã‡§≤ (Circle)</span> ‡§¨‡§ü‡§£‡§æ‡§µ‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§æ.</p>
                    </div>
                </div>

                <div class="flex gap-4">
                    <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-black shrink-0">3</div>
                    <div>
                        <h3 class="font-bold text-slate-800 mb-1">‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§™‡§æ‡§π‡§£‡•á</h3>
                        <p class="text-xs text-slate-500 leading-relaxed">‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§Ü‡§£‡§ø ‡§ú‡•Å‡§®‡§æ ‡§°‡•á‡§ü‡§æ ‡§™‡§æ‡§π‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§µ‡§∞‡§ö‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§™‡§±‡•ç‡§Ø‡§æ‡§§‡•Ä‡§≤ <span class="font-bold text-purple-600">'üìä'</span> ‡§¨‡§ü‡§£‡§æ‡§µ‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§æ.</p>
                    </div>
                </div>
            </div>

            <button onclick="document.getElementById('tutorialModal').classList.remove('flex'); document.getElementById('tutorialModal').classList.add('hidden');" class="w-full mt-8 bg-slate-900 text-white py-3 rounded-xl font-bold uppercase tracking-widest text-xs">‡§∏‡§Æ‡§ú‡§≤‡•á (Got it)</button>
        </div>
    </div>

    <div id="historyModal" class="fixed inset-0 z-50 bg-[#f8fafc] hidden flex-col overflow-y-auto">
        <div class="p-6 flex justify-between items-center sticky top-0 bg-[#f8fafc]/95 backdrop-blur-sm z-10 border-b border-slate-200 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center shadow-lg shadow-purple-500/30">
                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                </div>
                <h2 class="text-lg font-black uppercase text-slate-800 tracking-tight">History Log</h2>
            </div>
            <button onclick="document.getElementById('historyModal').classList.add('hidden'); document.getElementById('historyModal').classList.remove('flex');" class="w-10 h-10 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center font-bold transition-colors hover:bg-slate-300">‚úï</button>
        </div>
        <div class="p-6 pb-32">
            <div id="historyLogContainer" class="flex flex-col gap-6"></div>
        </div>
    </div>

    <div id="weightModal" class="fixed inset-0 z-50 bg-[#f8fafc] hidden flex-col overflow-y-auto">
        <div class="p-6 flex justify-between items-center sticky top-0 bg-[#f8fafc] z-10 border-b border-slate-200 shadow-sm"><h2 class="text-lg font-black uppercase text-slate-800">Report</h2><button onclick="document.getElementById('weightModal').classList.add('hidden'); document.getElementById('weightModal').classList.remove('flex');" class="w-10 h-10 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center font-bold">‚úï</button></div>
        <div class="p-6 pb-20">
            <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-xl mb-8 relative overflow-hidden">
                <div class="flex justify-between items-start mb-6 relative z-10"><div><h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">CURRENT WEIGHT</h3><span id="modalCurrentWeight" class="text-3xl font-black text-slate-800 tracking-tight">--</span></div><button onclick="document.getElementById('addWeightSection').classList.toggle('hidden')" class="w-10 h-10 bg-blue-600 rounded-xl text-white flex items-center justify-center shadow-lg shadow-blue-500/30 active:scale-95 transition-transform"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button></div>
                <div id="addWeightSection" class="hidden mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-200"><div class="flex gap-3"><input type="date" id="weightDateInput" class="flex-1 bg-white border border-slate-200 rounded-xl p-3 font-bold text-sm"><input type="number" id="newWeightInput" placeholder="KG" class="w-24 bg-white border border-slate-200 rounded-xl p-3 font-black text-center"></div><button onclick="logNewWeight()" class="w-full mt-3 bg-slate-800 text-white py-3 rounded-xl font-bold uppercase text-xs tracking-widest">Update Log</button></div>
                <div class="relative w-full h-48"><div id="chartBubble" class="absolute bg-slate-900 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-xl -translate-x-1/2 -translate-y-full transition-all duration-500" style="left: 50%; top: 50%;">--</div><svg id="weightChart" class="w-full h-full overflow-visible" preserveAspectRatio="none"><defs><linearGradient id="chartFill" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.4"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0"/></linearGradient></defs><path id="chartArea" d="" fill="url(#chartFill)" /><path id="chartLine" d="" fill="none" stroke="#3b82f6" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" /><g id="chartDots"></g></svg></div>
            </div>
            <div class="mb-8"><h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 text-center">BMI Breakdown</h3><div class="flex justify-between px-2 mb-2" id="bmiFigures"></div><div class="h-3 w-full rounded-full flex overflow-hidden relative"><div class="h-full bg-blue-400 flex-1"></div><div class="h-full bg-green-500 flex-[1.5]"></div><div class="h-full bg-yellow-400 flex-1"></div><div class="h-full bg-orange-500 flex-1"></div><div class="h-full bg-red-600 flex-1"></div><div id="bmiPointer" class="absolute top-0 bottom-0 w-1 bg-slate-900 shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-all duration-700 ease-out" style="left: 50%;"><div class="absolute -top-1.5 -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[8px] border-t-slate-900"></div><div class="absolute -bottom-1.5 -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-b-[8px] border-b-slate-900"></div></div></div><div class="flex justify-between text-[8px] font-bold text-slate-400 mt-2"><span>&lt;18.5</span><span>18.5-25</span><span>25-30</span><span>30-35</span><span>&gt;35</span></div><div class="text-center mt-4"><div id="bmiTextValue" class="text-2xl font-black text-slate-800">--</div><div id="bmiTextLabel" class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Normal Weight</div></div></div>
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">HISTORY</h3>
            <div id="historyList" class="flex flex-col gap-0 relative pb-10"></div>
        </div>
    </div>

    <div id="workoutModal" class="fixed inset-0 z-50 bg-[#f8fafc] hidden flex-col overflow-y-auto pb-20">
        <div class="p-4 flex justify-between items-center sticky top-0 bg-[#f8fafc]/95 backdrop-blur-sm z-10 border-b border-slate-200 shadow-sm">
            <div class="strip-gradient p-[2px] rounded-full mr-auto">
                <div class="bg-white px-4 py-2 rounded-full">
                    <span id="modalDay" class="text-sm font-black uppercase tracking-widest text-slate-800"></span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="showRestSelector()" class="h-10 pl-3 pr-4 rounded-full bg-white border-2 border-slate-200 text-slate-500 flex items-center gap-2 active:scale-95 transition-all shadow-sm">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span class="text-[10px] font-black tracking-widest">REST</span>
                </button>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center font-bold active:scale-90 hover:bg-slate-300 transition-colors">‚úï</button>
            </div>
        </div>
        <div class="p-4">
            <div id="modalTabs" class="flex gap-2 mb-6"></div>
            <div id="modalExercises" class="flex flex-col gap-4"></div>
        </div>
    </div>

    <div id="statsModal" class="fixed inset-0 z-50 bg-slate-900/50 hidden flex-col justify-center items-center p-6"><div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl"><h2 class="text-xl font-black text-slate-800 mb-4 uppercase">Stats</h2>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div><label class="text-[10px] font-bold text-slate-400 block mb-1">AGE</label><input type="number" id="ageInput" class="w-full bg-slate-100 rounded-lg p-2 font-bold"></div>
            <div><label class="text-[10px] font-bold text-slate-400 block mb-1">HEIGHT</label><input type="number" id="heightInput" class="w-full bg-slate-100 rounded-lg p-2 font-bold"></div>
        </div>
        <div class="mb-4"><label class="text-[10px] font-bold text-slate-400 block mb-1">REFERENCE WEIGHT (For Calories)</label><input type="number" id="statsWeightInput" class="w-full bg-slate-100 rounded-lg p-2 font-bold"></div>
        <div class="mb-4"><label class="text-[10px] font-bold text-slate-400 block mb-1">ACTIVITY</label><select id="activityInput" class="w-full bg-slate-100 rounded-lg p-2 font-bold"><option value="1.2">Sedentary</option><option value="1.375">Light</option><option value="1.55">Moderate</option><option value="1.725">Active</option></select></div><div class="flex gap-2 mb-4"><button id="btnMale" onclick="setGender('male')" class="flex-1 py-2 rounded font-bold">Male</button><button id="btnFemale" onclick="setGender('female')" class="flex-1 py-2 rounded font-bold">Female</button></div><button onclick="saveStats()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold uppercase">SAVE</button><button onclick="document.getElementById('statsModal').classList.remove('flex'); document.getElementById('statsModal').classList.add('hidden');" class="w-full mt-2 text-slate-400 font-bold text-xs py-2">CANCEL</button></div></div>

    <div id="deleteModal" class="fixed inset-0 z-[60] bg-black/50 hidden items-center justify-center"><div class="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full text-center"><h3 class="text-lg font-black text-slate-800 mb-4">Delete Entry?</h3><div class="flex gap-3"><button onclick="document.getElementById('deleteModal').classList.add('hidden'); document.getElementById('deleteModal').classList.remove('flex');" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">Cancel</button><button onclick="confirmDelete()" class="flex-1 py-3 bg-red-600 rounded-xl font-bold text-white">Delete</button></div></div></div>

    <script>
        // CONFIG
        const today = new Date();
        const days = ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
        const dayName = days[today.getDay()];
        const dateKey = today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, '0') + "-" + String(today.getDate()).padStart(2, '0');

        // REDUCED TO 6 EXERCISES PER GROUP (Main Workout)
        const workouts = {
            'MONDAY': { tabs: ['Chest', 'Triceps'], ex: [['Bench Press', 'Incline Press', 'Chest Fly', 'Cable Crossover', 'Dumbbell Pullover', 'Svend Press'], ['Skullcrushers', 'Rope Pushdown', 'Overhead Ext', 'Close Grip', 'Machine Dip', 'Kickbacks']] },
            'TUESDAY': { tabs: ['Back', 'Biceps'], ex: [['Lat Pulldown', 'Cable Row', 'T-Bar Row', 'Single Arm Row', 'Face Pulls', 'Straight Arm Pulldown'], ['Barbell Curl', 'Hammer Curl', 'Preacher Curl', 'Cable Curl', 'Conc. Curl', 'Incline Curl']] },
            'WEDNESDAY': { tabs: ['Legs', 'Shoulders'], ex: [['Leg Press', 'Hack Squat', 'Leg Extensions', 'Leg Curls', 'Calf Raise', 'Lunges'], ['Overhead Press', 'Lat Raise', 'Front Raise', 'Rear Delt Fly', 'Shrugs', 'Upright Row']] },
            'THURSDAY': { tabs: ['Chest Var', 'Triceps Var'], ex: [['Dumbbell Bench', 'Hammer Incline', 'Low Cable Fly', 'Smith Machine Press', 'Pec Deck', 'Landmine Press'], ['V-Bar Pushdown', 'French Press', 'Rev Grip Pushdown', 'Single Arm Ext', 'Dips', 'Close Grip Press']] },
            'FRIDAY': { tabs: ['Back Var', 'Biceps Var'], ex: [['Reverse Grip Lat Pulldown', 'Bent Over Row', 'Meadows Row', 'Seated Row', 'Machine High Row', 'Rope Face Pull'], ['Spider Curl', 'Zottman Curl', 'EZ Bar Curl', 'Bayesian Curl', 'Cross Body Curl', 'Reverse Curl']] },
            'SATURDAY': { tabs: ['Legs Var', 'Shoulders Var'], ex: [['Goblet Squat', 'Romanian Deadlift', 'Split Squat', 'Hip Thrust', 'Seated Calf Raise', 'Step Ups'], ['Arnold Press', 'Cable Lat Raise', 'Face Pull', 'Machine Press', 'Lateral Raise Machine', 'Front Plate Raise']] },
            'SUNDAY': { tabs: ['Rest', 'Recovery'], ex: [[], []] }
        };

        const coreExercises = ['Pushups', 'Pullups', 'Squats'];
        
        // ABS LEVELS DATA
        const absLevels = {
            'beginner': [
                { name: 'Jumping Jacks', time: '00:30', seconds: 30 },
                { name: 'Mountain Climbers', reps: '20' },
                { name: 'Heel Touch', reps: '20' },
                { name: 'Plank', time: '00:30', seconds: 30 },
                { name: 'Cobra Stretch', time: '00:30', seconds: 30 }
            ],
            'intermediate': [
                { name: 'Crunches', reps: '20' },
                { name: 'Leg Raises', reps: '15' },
                { name: 'Russian Twist', reps: '24' },
                { name: 'Flutter Kicks', time: '00:30', seconds: 30 },
                { name: 'Plank Jacks', reps: '15' },
                { name: 'Side Plank', time: '00:30', seconds: 30 }
            ],
            'advanced': [
                { name: 'Bicycle Crunches', reps: '24' },
                { name: 'V-Ups', reps: '15' },
                { name: 'Hollow Body', time: '00:45', seconds: 45 },
                { name: 'Side Plank', time: '00:45', seconds: 45 },
                { name: 'Sit-ups', reps: '30' },
                { name: 'Dead Bug', reps: '20' }
            ]
        };

        const videoLinks = { 'Reverse Grip Lat Pulldown': 'https://youtube.com/shorts/rguA3pm73rs?si=MH9VjC8IksY-P3hX', 'Bent Over Row': 'https://youtube.com/shorts/phVtqawIgbk?si=7cTPYY7KbzFW_9n-', 'Meadows Row': 'https://youtube.com/shorts/Sr2q7i-i8X0?si=-d4Q3nm25Crabl9s', 'Straight Arm Pulldown': 'https://youtube.com/shorts/hAMcfubonDc?si=Y3pRCQqTtPtlCTuM' };

        // STATE
        let currentTab = 0, cardioVal = 0, stepsVal = 0, streak = 0, streakLocked = false;
        let userName = "USER";
        let stats = { age: 25, height: 175, gender: 'male', activity: 1.55, weight: 75.0 };
        let exerciseData = {}; weightHistory = []; deleteIndex = -1; isCoreMode = false;
        let activeAbsLevel = null;
        let absViewMode = 'levels'; 

        // --- REST TIMER STATE ---
        let timerInterval = null;
        let timerEndTime = null; 
        let timerTotalDuration = 0; 
        let currentPresetIndex = -1;

        // SHOW REST SELECTOR (BUTTON CLICK)
        function showRestSelector() {
            document.getElementById('fullscreenTimer').classList.remove('hidden');
            document.getElementById('fullscreenTimer').classList.add('flex');
            document.getElementById('restSelector').classList.remove('hidden');
            document.getElementById('restSelector').classList.add('flex');
            document.getElementById('timerContainer').classList.add('hidden'); // Hide ring initially
            
            // Set label
            document.getElementById('timerTitle').innerText = "SELECT REST";
        }
        
        function hideRestSelector() {
            document.getElementById('restSelector').classList.add('hidden');
            document.getElementById('restSelector').classList.remove('flex');
            document.getElementById('timerContainer').classList.remove('hidden'); // Show ring
        }

        // TIMER START FUNCTION (Updated for Label)
        function startTimerInterval(customSeconds, labelText = "") {
            timerTotalDuration = customSeconds; 
            timerEndTime = Date.now() + (customSeconds * 1000);
            saveData();
            
            // Set Label
            const titleEl = document.getElementById("timerTitle");
            
            if (labelText) {
                titleEl.innerText = labelText;
            } else {
                titleEl.innerText = "RESTING"; 
            }

            // SHOW FULLSCREEN OVERLAY
            document.getElementById('fullscreenTimer').classList.remove('hidden');
            document.getElementById('fullscreenTimer').classList.add('flex');
            
            checkTimerTick();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(checkTimerTick, 100); 
        }

        function checkTimerTick() {
            if(!timerEndTime) return;
            const now = Date.now();
            const remainingMs = timerEndTime - now;
            const remainingSec = Math.ceil(remainingMs / 1000);

            if (remainingSec > 0) {
                const m = Math.floor(remainingSec / 60);
                const s = remainingSec % 60;
                const timeString = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                
                document.getElementById('overlayTimerDisplay').innerText = timeString;
                
                // Update Circular Progress
                const circumference = 880; // 2 * PI * 140
                const offset = circumference - (remainingMs / (timerTotalDuration * 1000)) * circumference;
                document.getElementById('timerProgressRing').style.strokeDashoffset = offset;

            } else { finishTimer(); }
        }

        function updateTimerUI(isActive) {
            const btn = document.getElementById('restTimerBtn');
            const txt = document.getElementById('timerDisplay');
            if (isActive) {
                btn.className = "h-10 pl-3 pr-4 rounded-full bg-indigo-600 border-2 border-indigo-600 text-white flex items-center gap-2 active:scale-95 transition-all shadow-md animate-pulse";
            } else {
                btn.className = "h-10 pl-3 pr-4 rounded-full bg-white border-2 border-slate-200 text-slate-500 flex items-center gap-2 active:scale-95 transition-all shadow-sm";
                txt.innerText = "REST";
                currentPresetIndex = -1;
            }
        }

        function finishTimer() {
            clearInterval(timerInterval); timerInterval = null; timerEndTime = null; saveData(); 
            
            // CONFETTI BLAST
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 });
            if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500, 200, 500, 200, 500]);
            
            document.getElementById('fullscreenTimer').classList.add('hidden');
            document.getElementById('fullscreenTimer').classList.remove('flex');
        }

        function resetTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null; timerEndTime = null; saveData(); 
            document.getElementById('fullscreenTimer').classList.add('hidden');
            document.getElementById('fullscreenTimer').classList.remove('flex');
            // Ensure selectors reset
            document.getElementById('restSelector').classList.add('hidden');
        }

        function restoreTimer() {
            if (timerEndTime) {
                const now = Date.now();
                if (timerEndTime > now) { 
                    const remaining = Math.ceil((timerEndTime - now) / 1000);
                    timerTotalDuration = remaining + 1; 
                    
                    // Logic to show ring immediately if restoring
                    document.getElementById('restSelector').classList.add('hidden');
                    document.getElementById('timerContainer').classList.remove('hidden');
                    startTimerInterval(remaining, "RESUMED"); 
                } else { timerEndTime = null; saveData(); }
            }
        }

        function init() {
            loadData();
            document.getElementById('todayPreview').innerText = workouts[dayName].tabs.length ? `${workouts[dayName].tabs[0]} & ${workouts[dayName].tabs[1]}` : "REST";
            document.getElementById('userNameInput').value = userName;
            document.getElementById('ageInput').value = stats.age;
            document.getElementById('heightInput').value = stats.height;
            document.getElementById('activityInput').value = stats.activity;
            document.getElementById('statsWeightInput').value = stats.weight;
            updateGenderUI();
            document.getElementById('weightDateInput').valueAsDate = new Date();
            calcTotalProgress();
            updateCoreProgress();
            refreshWeightUI();
            restoreTimer();
            cleanOldHistory();
        }

        function cleanOldHistory() {
            const historyMap = {}; 
            Object.keys(exerciseData).filter(k => k.match(/^\d{4}-\d{2}-\d{2}$/)).forEach(date => {
                const dayIdx = new Date(date).getDay();
                if(!historyMap[dayIdx]) historyMap[dayIdx] = [];
                historyMap[dayIdx].push(date);
            });
            let changed = false;
            for(let dayIdx in historyMap) {
                const dates = historyMap[dayIdx].sort((a,b) => new Date(b) - new Date(a)); 
                if (dates.length > 4) {
                    const toRemove = dates.slice(4); 
                    toRemove.forEach(d => { delete exerciseData[d]; changed = true; });
                }
            }
            if(changed) saveData();
        }

        function saveData() {
            const data = { date: dateKey, user: document.getElementById('userNameInput').value, stats: stats, exerciseData: exerciseData, weightHistory: weightHistory, streak: streak, streakLocked: streakLocked, timerEndTime: timerEndTime, timerPreset: currentPresetIndex };
            try { localStorage.setItem('fitnessProFinal', JSON.stringify(data)); } catch(e) {}
        }

        function loadData() {
            const raw = localStorage.getItem('fitnessProFinal');
            if(raw) {
                const data = JSON.parse(raw);
                userName = data.user || "USER"; 
                stats = data.stats || { age: 25, height: 175, gender: 'male', activity: 1.55, weight: 75.0 }; 
                exerciseData = data.exerciseData || {}; weightHistory = data.weightHistory || []; streak = data.streak || 0;
                if(weightHistory.length === 0 && stats.weight) weightHistory.push({date: Date.now(), weight: parseFloat(stats.weight)});
                timerEndTime = data.timerEndTime || null;
                currentPresetIndex = data.timerPreset !== undefined ? data.timerPreset : -1;
                if(data.date === dateKey) { streakLocked = data.streakLocked || false; }
                else { streakLocked = false; saveData(); }
            }
        }

        function updateCoreProgress() {
            // General Core
            let coreTotal = coreExercises.length;
            let coreDone = 0;
            coreExercises.forEach(ex => { if(exerciseData[dateKey] && exerciseData[dateKey][ex] && exerciseData[dateKey][ex].completed) coreDone++; });
            document.getElementById('coreProgressBar').style.width = (coreDone / coreTotal * 100) + '%';

            // Abs
            let absTotal = 3; 
            let absDone = 0;
            if (activeAbsLevel) {
               absLevels[activeAbsLevel].forEach(ex => {
                   if(exerciseData[dateKey] && exerciseData[dateKey][ex.name] && exerciseData[dateKey][ex.name].completed) absDone++;
               });
               document.getElementById('absProgressBar').style.width = (absDone / absLevels[activeAbsLevel].length * 100) + '%';
            } else {
               absLevels['beginner'].forEach(ex => { if(exerciseData[dateKey] && exerciseData[dateKey][ex.name] && exerciseData[dateKey][ex.name].completed) absDone++; });
               document.getElementById('absProgressBar').style.width = (absDone / absLevels['beginner'].length * 100) + '%';
            }
        }

        // --- RENDER LOGIC ---
        function renderExercises(list) {
            const container = document.getElementById('modalExercises'); container.innerHTML = "";
            list.forEach((exName) => {
                const dayData = exerciseData[dateKey] || {};
                // Handle complex object if passed from Abs logic
                const name = typeof exName === 'object' ? exName.name : exName;
                const timeStr = typeof exName === 'object' && exName.time ? exName.time : null;
                const seconds = typeof exName === 'object' && exName.seconds ? exName.seconds : 0;
                const repsStr = typeof exName === 'object' && exName.reps ? exName.reps + " REPS" : null;

                const ex = dayData[name] || { sets: [{w:'',r:''}, {w:'',r:''}, {w:'',r:''}], completed: false };
                
                let videoBtn = '';
                if(videoLinks[name]) {
                    videoBtn = `<a href="${videoLinks[name]}" target="_blank" class="ml-2 inline-flex items-center justify-center w-6 h-6 bg-red-100 text-red-600 rounded-full hover:bg-red-500 hover:text-white transition-colors active:scale-95"><svg class="w-3 h-3 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></a>`;
                }

                // Timer Button Logic (Fixed for Abs)
                let timerBtn = '';
                if (timeStr) {
                    // Pass name to timer function
                    timerBtn = `<div onclick="startTimerInterval(${seconds}, '${name.toUpperCase()}'); hideRestSelector(); document.getElementById('timerContainer').classList.remove('hidden'); event.stopPropagation();" class="cursor-pointer bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-xs font-black tracking-widest flex items-center gap-2 active:scale-95 transition-transform hover:bg-blue-100 border border-blue-100"><span class="text-lg">‚è±</span> START ${timeStr}</div>`;
                }

                let contentHTML = '';
                
                if (isCoreMode && activeAbsLevel) {
                    // ABS MODE: Simple List Style like Image 2
                    contentHTML = `
                    <div class="flex items-center justify-between mt-2 pl-1">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">${repsStr || timeStr || "3 SETS"}</span>
                        </div>
                        ${timerBtn}
                    </div>`;
                } else {
                    // GYM MODE: Input Sets
                    for(let i=0; i<3; i++) { 
                        contentHTML += `
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-[10px] font-bold text-slate-400 w-6">SET ${i+1}</span>
                            <div class="flex items-center flex-1 bg-slate-100 border border-slate-200 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 transition-all">
                                <input type="number" placeholder="KG" value="${ex.sets[i].w}" oninput="logSet('${name}', ${i}, 'w', this.value)" class="w-1/2 p-2 text-center text-sm font-bold bg-transparent border-r border-slate-200 text-slate-800 placeholder:text-slate-300">
                                <input type="number" placeholder="REPS" value="${ex.sets[i].r}" oninput="logSet('${name}', ${i}, 'r', this.value)" class="w-1/2 p-2 text-center text-sm font-bold bg-transparent text-slate-800 placeholder:text-slate-300">
                            </div>
                        </div>`; 
                    }
                }

                const card = document.createElement('div'); 
                card.className = "pro-card p-5 rounded-2xl relative overflow-hidden transition-all duration-300";
                if(ex.completed) { card.style.borderColor = "#4ade80"; card.style.boxShadow = "0 4px 12px -2px rgba(74, 222, 128, 0.2)"; } 
                card.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                        <h4 class="font-black text-slate-800 text-lg uppercase tracking-tight">${name}</h4>${videoBtn}
                        ${ !activeAbsLevel ? `<div id="compare-${name.replace(/[\s\/]/g, '')}" class="text-[9px] font-bold text-blue-500 cursor-pointer bg-blue-50 px-2 py-1 rounded w-fit active:scale-95" onclick="showHistory('${name}')">COMPARE</div>` : '' }
                    </div>
                    <div class="cursor-pointer transition-transform active:scale-90" onclick="toggleExerciseComplete('${name}')">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 ${ex.completed ? 'bg-green-500 border-green-500' : 'bg-slate-100 border-slate-200'} transition-all duration-300">
                            <svg class="w-6 h-6 text-white ${ex.completed ? 'opacity-100 scale-100' : 'opacity-0 scale-50'} transition-all duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                        </div>
                    </div>
                </div>${contentHTML}`;
                container.appendChild(card);
            });
        }

        function logSet(exName, setIdx, field, val) {
            if(!exerciseData[dateKey]) exerciseData[dateKey] = {};
            if(!exerciseData[dateKey][exName]) exerciseData[dateKey][exName] = { sets: [{w:'',r:''}, {w:'',r:''}, {w:'',r:''}], completed: false };
            exerciseData[dateKey][exName].sets[setIdx][field] = val;
            if(val) { if(!exerciseData.history) exerciseData.history = {}; exerciseData.history[exName] = JSON.parse(JSON.stringify(exerciseData[dateKey][exName].sets)); }
            saveData();
        }

        function showHistory(exName) {
            const target = document.getElementById(`compare-${exName.replace(/[\s\/]/g, '')}`);
            const hist = exerciseData.history ? exerciseData.history[exName] : null;
            if(hist && Array.isArray(hist)) { const txt = hist.map(s => (s.w && s.r) ? `${s.w}x${s.r}` : '').filter(Boolean).join(' | '); target.innerText = txt || "No Data"; } else { target.innerText = "No Prev Data"; }
        }

        function toggleExerciseComplete(exName) {
            if(!exerciseData[dateKey]) exerciseData[dateKey] = {};
            const name = typeof exName === 'object' ? exName.name : exName;
            if(!exerciseData[dateKey][name]) exerciseData[dateKey][name] = { sets: [{w:'',r:''}, {w:'',r:''}, {w:'',r:''}], completed: false };
            
            const newState = !exerciseData[dateKey][name].completed;
            exerciseData[dateKey][name].completed = newState;
            if(newState) { if(navigator.vibrate) navigator.vibrate(50); confetti({ particleCount: 80, spread: 80, origin: { y: 0.6 }, colors: ['#FFD700', '#FF1493'] }); }
            saveData();
            
            if(isCoreMode) {
                if (activeAbsLevel) {
                    renderExercises(absLevels[activeAbsLevel]);
                    updateCoreProgress();
                } else if (currentTab === 'level_select') {
                    // Do nothing
                } else {
                    renderExercises(coreExercises);
                    updateCoreProgress();
                }
            } else { 
                renderExercises(workouts[dayName].ex[currentTab]); 
                calcTotalProgress(); 
            }
        }

        function calcTotalProgress() {
            if(!exerciseData[dateKey]) { updateCircle(0); return; }
            let total = 0, done = 0;
            const w = workouts[dayName]; if(!w.ex[0]) return;
            const allEx = [...w.ex[0], ...w.ex[1]];
            allEx.forEach(ex => { total++; if(exerciseData[dateKey][ex] && exerciseData[dateKey][ex].completed) done++; });
            const pct = total === 0 ? 0 : Math.round((done / total) * 100);
            updateCircle(pct);
            if(done === total && total > 0 && !streakLocked) { streak++; streakLocked = true; saveData(); }
            document.getElementById('streakCount').innerText = streak;
        }

        function updateCircle(pct) { document.getElementById('circleRing').style.strokeDashoffset = 175 - (175 * pct / 100); document.getElementById('gymPercent').innerText = pct + "%"; }

        function openWeightModal() { 
            document.getElementById('weightModal').classList.remove('hidden'); 
            document.getElementById('weightModal').classList.add('flex'); 
            setTimeout(() => { refreshWeightUI(); }, 50);
        }

        function logNewWeight() {
            const wInput = document.getElementById('newWeightInput');
            const dInput = document.getElementById('weightDateInput');
            const val = parseFloat(wInput.value); 
            if(!val || val <= 0) { alert("Please enter a valid weight"); return; }
            let dateTs = Date.now();
            if(dInput.value) { const d = new Date(dInput.value); d.setHours(12,0,0,0); dateTs = d.getTime(); }
            weightHistory.push({date: dateTs, weight: val});
            stats.weight = val;
            saveData(); refreshWeightUI(); wInput.value = ""; document.getElementById('addWeightSection').classList.add('hidden');
        }
        
        function refreshWeightUI() {
            if(!weightHistory || weightHistory.length === 0) return;
            const sortedByDate = [...weightHistory].sort((a,b) => a.date - b.date);
            const latest = sortedByDate[sortedByDate.length-1].weight;
            document.getElementById('displayWeight').innerText = latest;
            document.getElementById('modalCurrentWeight').innerText = latest + " KG";
            const h = stats.height ? stats.height / 100 : 1.75; 
            const bmi = (latest / (h*h)).toFixed(1);
            const colors = ['text-blue-400', 'text-green-500', 'text-yellow-400', 'text-orange-500', 'text-red-600'];
            const labels = ['Underweight', 'Normal', 'Overweight', 'Obese', 'Extremely Obese'];
            let activeIndex = 0;
            if(bmi < 18.5) activeIndex = 0; else if(bmi < 25) activeIndex = 1; else if(bmi < 30) activeIndex = 2; else if(bmi < 35) activeIndex = 3; else activeIndex = 4;
            const color = colors[activeIndex]; const label = labels[activeIndex];
            const figuresContainer = document.getElementById('bmiFigures');
            if(figuresContainer) {
                figuresContainer.innerHTML = '';
                for(let i=0; i<5; i++) {
                    const isActive = i === activeIndex;
                    const opacity = isActive ? 'opacity-100 scale-110' : 'opacity-30 scale-90';
                    const svgBody = `<svg class="w-6 h-10 ${colors[i]} ${opacity} transition-all duration-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C13.1 2 14 2.9 14 4S13.1 6 12 6 10 5.1 10 4 10.9 2 12 2M12 22C11.4 22 11 21.6 11 21V16H9V9H15V16H13V21C13 21.6 12.6 22 12 22Z" transform="scale(${1 + (i * 0.15)}, 1) translate(${-i}, 0)" /></svg>`;
                    figuresContainer.innerHTML += svgBody;
                }
            }
            document.getElementById('bmiTextValue').innerText = bmi;
            document.getElementById('bmiTextValue').className = `text-4xl font-black ${color}`;
            document.getElementById('bmiTextLabel').innerText = label;
            document.getElementById('bmiTextLabel').className = `text-[10px] font-bold uppercase tracking-widest ${color}`;
            document.getElementById('bmiDisplayMain').innerText = `BMI: ${bmi}`;
            const minBMI = 15, maxBMI = 40;
            let percent = ((bmi - minBMI) / (maxBMI - minBMI)) * 100;
            if(percent < 0) percent = 0; if(percent > 100) percent = 100;
            document.getElementById('bmiPointer').style.left = percent + "%";
            calculateCalories();
            renderChart(); renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('historyList'); list.innerHTML = "";
            const sorted = [...weightHistory].sort((a,b) => b.date - a.date);
            sorted.forEach((item) => {
                const idx = weightHistory.indexOf(item);
                const d = new Date(item.date).toLocaleDateString('en-US', {month:'short', day:'numeric'});
                list.innerHTML += `<div class="history-item relative pl-8 pb-4"><div class="history-line"></div><div class="absolute left-2 top-[28px] w-2.5 h-2.5 rounded-full bg-blue-400 ring-4 ring-white z-10"></div><div class="pro-card p-3 rounded-2xl flex justify-between items-center transition-colors hover:bg-slate-50"><span class="text-xs font-bold text-slate-500 tracking-wide">${d}</span><div class="flex items-center gap-3"><span class="text-lg font-black text-slate-800">${item.weight} <span class="text-xs text-slate-400">KG</span></span><button onclick="requestDelete(${idx})" class="w-8 h-8 flex items-center justify-center text-red-400 bg-red-50 rounded-full hover:bg-red-500 hover:text-white transition-all active:scale-90">‚úï</button></div></div></div>`;
            });
        }
        
        function requestDelete(idx) { deleteIndex = idx; document.getElementById('deleteModal').classList.remove('hidden'); document.getElementById('deleteModal').classList.add('flex'); }
        function confirmDelete() { if(deleteIndex > -1) { weightHistory.splice(deleteIndex, 1); saveData(); refreshWeightUI(); } document.getElementById('deleteModal').classList.add('hidden'); document.getElementById('deleteModal').classList.remove('flex'); }

        function renderChart() {
            const svg = document.getElementById('weightChart'); 
            if(!weightHistory || weightHistory.length < 2) return;
            const w = svg.clientWidth; const h = svg.clientHeight;
            if(w === 0 || h === 0) return; 
            const sorted = [...weightHistory].sort((a,b) => a.date - b.date);
            const weights = sorted.map(i => i.weight);
            const minW = Math.min(...weights) - 2;
            const maxW = Math.max(...weights) + 2;
            const range = maxW - minW;
            const points = sorted.map((item, i) => {
                const x = (i / (sorted.length - 1)) * w;
                const y = h - ((item.weight - minW) / range) * h;
                return {x, y, w: item.weight};
            });
            let path = "";
            if (points.length > 1) {
                path = `M ${points[0].x} ${points[0].y}`;
                for (let i = 0; i < points.length - 1; i++) {
                    const curr = points[i]; const next = points[i + 1];
                    const cp1x = curr.x + (next.x - curr.x) * 0.5; const cp1y = curr.y;
                    const cp2x = curr.x + (next.x - curr.x) * 0.5; const cp2y = next.y;
                    path += ` C ${cp1x} ${cp1y} ${cp2x} ${cp2y} ${next.x} ${next.y}`;
                }
            }
            const fillPath = path + ` L ${w} ${h} L 0 ${h} Z`;
            document.getElementById('chartArea').setAttribute('d', fillPath);
            document.getElementById('chartLine').setAttribute('d', path);
            const lastPt = points[points.length - 1];
            const bubble = document.getElementById('chartBubble');
            if(bubble) { bubble.style.left = `${lastPt.x}px`; bubble.style.top = `${lastPt.y - 15}px`; bubble.innerText = `${lastPt.w}kg`; }
        }

        function openHistoryModal() {
            const container = document.getElementById('historyLogContainer');
            container.innerHTML = "";
            const dates = Object.keys(exerciseData).filter(k => k.match(/^\d{4}-\d{2}-\d{2}$/)).sort((a,b) => new Date(b) - new Date(a));
            if (dates.length === 0) { container.innerHTML = "<div class='text-center text-slate-400 font-bold mt-10'>NO WORKOUTS YET</div>"; } else {
                const groupedHistory = {};
                dates.forEach(d => {
                    const dayIdx = new Date(d).getDay();
                    const dayName = days[dayIdx];
                    const muscleGroup = workouts[dayName].tabs.length ? workouts[dayName].tabs.join(' & ').replace(/ Var/g, '') : "REST DAY";
                    if (!groupedHistory[muscleGroup]) groupedHistory[muscleGroup] = [];
                    groupedHistory[muscleGroup].push(d);
                });
                for (const [muscle, groupDates] of Object.entries(groupedHistory)) {
                    let groupHTML = `<div class="mb-2"><h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3 pl-1">${muscle}</h3>`;
                    groupDates.forEach(d => {
                        const dayData = exerciseData[d];
                        let exHTML = "";
                        for (const [name, data] of Object.entries(dayData)) {
                            const validSets = data.sets.filter(s => s.w || s.r).map(s => `${s.w || 0}kg√ó${s.r || 0}`).join(', ');
                            if (validSets) { exHTML += `<div class="flex justify-between items-start text-sm py-2 border-b border-slate-50 last:border-0"><span class="font-bold text-slate-700 w-1/3 truncate">${name}</span><span class="text-slate-500 text-xs font-mono text-right flex-1">${validSets}</span></div>`; }
                        }
                        if (exHTML) {
                            const dateObj = new Date(d); const prettyDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            groupHTML += `<div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm mb-3"><div class="flex items-center gap-2 mb-2 pb-2 border-b border-slate-100"><div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div><span class="text-[10px] font-black text-slate-400 uppercase tracking-wide">${prettyDate}</span></div><div class="flex flex-col">${exHTML}</div></div>`;
                        }
                    });
                    groupHTML += `</div>`;
                    container.innerHTML += groupHTML;
                }
            }
            document.getElementById('historyModal').classList.remove('hidden'); 
            document.getElementById('historyModal').classList.add('flex');
        }

        // --- TUTORIAL MODAL FUNCTION (ADDED) ---
        function openTutorialModal() {
            document.getElementById('tutorialModal').classList.remove('hidden');
            document.getElementById('tutorialModal').classList.add('flex');
        }

        function openGymModal() {
            isCoreMode = false;
            document.getElementById('modalDay').innerText = dayName;
            document.getElementById('modalTabs').classList.remove('hidden');
            document.getElementById('modalTabs').className = "flex p-1 bg-slate-100 rounded-xl mb-6 relative select-none";
            const w = workouts[dayName];
            if(w.tabs.length) {
                document.getElementById('modalTabs').innerHTML = w.tabs.map((t, i) => {
                    const displayName = t.replace(' Var', '');
                    const activeClass = "glass-purple-active shadow-lg scale-[1.02] ring-1 ring-white/20";
                    const inactiveClass = "text-slate-500 hover:text-slate-700 hover:bg-white/50";
                    return `<button onclick="switchTab(${i})" class="flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out ${currentTab === i ? activeClass : inactiveClass}">${displayName}</button>`;
                }).join('');
                renderExercises(w.ex[currentTab]);
            } else { document.getElementById('modalExercises').innerHTML = "REST DAY"; }
            document.getElementById('workoutModal').classList.remove('hidden'); 
            document.getElementById('workoutModal').classList.add('flex');
        }

        function openCoreModal(type) { 
            isCoreMode = true;
            document.getElementById('modalTabs').classList.add('hidden');
            
            if (type === 'abs') {
                absViewMode = 'levels'; 
                document.getElementById('modalDay').innerText = "ABS LEVEL";
                const container = document.getElementById('modalExercises');
                container.innerHTML = `
                    <div onclick="selectAbsLevel('beginner')" class="cursor-pointer pro-card p-8 rounded-3xl grad-beginner relative overflow-hidden text-white mb-4 active:scale-95 transition-transform shine-effect">
                        <div class="relative z-10"><h3 class="font-black text-2xl mb-1">BEGINNER</h3><p class="text-sm font-bold opacity-80 tracking-wide">LOSE BELLY FAT</p></div>
                    </div>
                    <div onclick="selectAbsLevel('intermediate')" class="cursor-pointer pro-card p-8 rounded-3xl grad-intermediate relative overflow-hidden text-white mb-4 active:scale-95 transition-transform shine-effect">
                        <div class="relative z-10"><h3 class="font-black text-2xl mb-1">INTERMEDIATE</h3><p class="text-sm font-bold opacity-80 tracking-wide">ROCK HARD ABS</p></div>
                    </div>
                    <div onclick="selectAbsLevel('advanced')" class="cursor-pointer pro-card p-8 rounded-3xl grad-advanced relative overflow-hidden text-white mb-4 active:scale-95 transition-transform shine-effect">
                        <div class="relative z-10"><h3 class="font-black text-2xl mb-1">ADVANCED</h3><p class="text-sm font-bold opacity-80 tracking-wide">SIX PACK ABS</p></div>
                    </div>
                `;
            } else {
                activeAbsLevel = null;
                document.getElementById('modalDay').innerText = "CORE WORKOUT";
                renderExercises(coreExercises);
            }
            
            document.getElementById('workoutModal').classList.remove('hidden'); 
            document.getElementById('workoutModal').classList.add('flex'); 
        }

        function selectAbsLevel(level) {
            absViewMode = 'workout';
            activeAbsLevel = level;
            document.getElementById('modalDay').innerText = level.toUpperCase();
            renderExercises(absLevels[level]);
        }

        function closeModal() { 
            if (isCoreMode && activeAbsLevel && absViewMode === 'workout') {
                openCoreModal('abs');
            } else {
                document.getElementById('workoutModal').classList.add('hidden'); 
                document.getElementById('workoutModal').classList.remove('flex'); 
            }
        }

        function switchTab(i) { 
            currentTab = i; const w = workouts[dayName]; renderExercises(w.ex[currentTab]); 
            const btns = document.getElementById('modalTabs').children; 
            const activeClass = "flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out glass-purple-active shadow-lg scale-[1.02] ring-1 ring-white/20";
            const inactiveClass = "flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out text-slate-500 hover:text-slate-700 hover:bg-white/50";
            for(let b of btns) b.className = inactiveClass; btns[i].className = activeClass; 
        }
        function setGender(g) { stats.gender = g; updateGenderUI(); }
        function updateGenderUI() { const m = document.getElementById('btnMale'), f = document.getElementById('btnFemale'); const active = "bg-blue-600 text-white shadow-md"; const inactive = "bg-slate-100 text-slate-400"; if(stats.gender === 'male') { m.className = `flex-1 py-2 rounded font-bold ${active}`; f.className = `flex-1 py-2 rounded font-bold ${inactive}`; } else { f.className = `flex-1 py-2 rounded font-bold ${active}`; m.className = `flex-1 py-2 rounded font-bold ${inactive}`; } }
        function openStatsModal() { document.getElementById('statsModal').classList.remove('hidden'); document.getElementById('statsModal').classList.add('flex'); setGender(stats.gender); }
        function saveStats() { stats.age = parseFloat(document.getElementById('ageInput').value) || 25; stats.height = parseFloat(document.getElementById('heightInput').value) || 175; stats.activity = parseFloat(document.getElementById('activityInput').value) || 1.55; stats.weight = parseFloat(document.getElementById('statsWeightInput').value) || stats.weight; saveData(); document.getElementById('statsModal').classList.remove('flex'); document.getElementById('statsModal').classList.add('hidden'); calculateCalories(); }
        function calculateCalories() { const w = stats.weight || 75; let offset = stats.gender === 'male' ? 5 : -161; let bmr = (10*w) + (6.25*stats.height) - (5*stats.age) + offset; const tdee = Math.round(bmr * stats.activity); document.getElementById('calMaintain').innerText = tdee; document.getElementById('calLoss').innerText = tdee - 500; document.getElementById('calGain').innerText = tdee + 300; }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fitness Pro - Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* --- THEME ENGINE --- */
        :root {
            --bg-dark: #050505;
            --theme-color: #3b82f6;
        }

        body { 
            background-color: var(--bg-dark); 
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000000 95%);
            color: #f8fafc; 
            overscroll-behavior-y: none; 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            touch-action: pan-y;
        }

        .layer-boost { transform: translateZ(0); will-change: transform, opacity; }

        /* --- GLASS CARD SYSTEM --- */
        .glass-card {
            background: #0a0a0a; 
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px;
            position: relative;
            overflow: hidden; 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .glass-card:active { transform: scale(0.98); }

        /* COLORS & GRADIENTS */
        .card-fire { background: linear-gradient(135deg, #450a0a 0%, #7c2d12 40%, #0a0a0a 100%); border: 1px solid #7f1d1d; }
        .card-gold { background: linear-gradient(135deg, #422006 0%, #854d0e 40%, #0a0a0a 100%); border: 1px solid #a16207; }
        .card-ocean { background: linear-gradient(135deg, #0c4a6e 0%, #0369a1 40%, #0a0a0a 100%); border: 1px solid #075985; }
        .card-green { background: linear-gradient(135deg, #064e3b 0%, #065f46 40%, #0a0a0a 100%); border: 1px solid #059669; }
        .card-purple { background: linear-gradient(135deg, #3b0764 0%, #581c87 40%, #0a0a0a 100%); border: 1px solid #7e22ce; }
        .card-pink { background: linear-gradient(135deg, #831843 0%, #9d174d 40%, #0a0a0a 100%); border: 1px solid #be185d; }

        /* UI ELEMENTS */
        .modal-bg { background-color: #000000; }
        .grad-pill { background: linear-gradient(135deg, #3b82f6, #2563eb); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .action-pill {
            padding: 5px 12px; border-radius: 999px; font-size: 10px; font-weight: 900; letter-spacing: 0.05em;
            display: inline-flex; align-items: center; gap: 5px; transition: all 0.2s; text-transform: uppercase; cursor: pointer; backdrop-filter: blur(4px);
        }
        .action-pill:active { transform: scale(0.95); }
        .pill-video { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
        .pill-compare { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .pill-timer { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }

        .modal-exercise-card { background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0.4) 100%); border: 1px solid rgba(255,255,255,0.08); border-left: 3px solid #3b82f6; }
        .modal-active-tab { background: #3b82f6; color: white; box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); border: 1px solid rgba(255,255,255,0.2); transform: scale(1.02); }

        .glass-input-styled { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; transition: all 0.3s ease; }
        .glass-input-styled:focus { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); background: rgba(0,0,0,0.6); }

        .neon-checkbox { width: 32px; height: 32px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .neon-checkbox.checked { background: #3b82f6; border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); transform: scale(1.1); }

        .emoji-watermark { position: absolute; right: 0; bottom: -5px; font-size: 5.5rem; line-height: 1; opacity: 0.12; pointer-events: none; z-index: 0; filter: grayscale(0.1); }
        .modal-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; opacity: 0.04; pointer-events: none; fill: white; z-index: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input:focus { outline: none; }
        * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        
        .muscle-header { display: flex; align-items: center; background: linear-gradient(90deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 100%); padding: 10px 16px; border-radius: 12px; border-left: 4px solid #3b82f6; margin: 24px 0 12px 0; color: rgba(255,255,255,0.9); font-size: 11px; font-weight: 900; letter-spacing: 0.2em; text-transform: uppercase; backdrop-filter: blur(4px); }

        /* --- TIMER ANIMATIONS --- */
        @keyframes gradientBounce {
            0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
        }
        .timer-active-bg {
            background: linear-gradient(-45deg, #000000, #1e1b4b, #312e81, #0f172a, #000000);
            background-size: 400% 400%;
            animation: gradientBounce 6s ease infinite;
        }
        .glass-digits-container {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 30px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 10px 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 30px rgba(255,255,255,0.02);
            text-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 20;
        }
    </style>
</head>
<body class="min-h-screen p-4 pb-36 select-none layer-boost">

    <div class="flex flex-col gap-5 max-w-md mx-auto relative z-10">
        <div class="flex items-center justify-between pt-2 px-1">
            <div class="flex flex-col justify-center">
                <label class="text-[10px] font-bold text-gray-500 tracking-[0.2em] mb-1">WELCOME BACK,</label>
                <input type="text" id="userNameInput" value="USER" oninput="saveData()" class="bg-transparent text-3xl font-black uppercase w-56 text-white border-none p-0 leading-none truncate focus:text-blue-500">
            </div>
            <button onclick="document.getElementById('settingsModal').classList.remove('hidden'); document.getElementById('settingsModal').classList.add('flex');" class="w-10 h-10 rounded-full bg-[#111] border border-[#222] flex items-center justify-center text-slate-400 active:scale-90 transition-transform hover:text-white">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
        </div>

        <div class="glass-card card-fire p-5">
            <div class="emoji-watermark">üî•</div>
            <div class="z-content flex items-center justify-between">
                <div>
                    <p class="text-[10px] font-bold text-orange-200/70 tracking-[0.15em] uppercase mb-1">Streak</p>
                    <div class="flex items-center gap-3">
                        <span id="streakCount" class="text-6xl font-black italic text-white tracking-tighter drop-shadow-lg">0</span>
                        <span class="text-4xl filter drop-shadow-md">üèÜ</span>
                    </div>
                </div>
                <div class="text-[10px] font-bold text-orange-100/60 text-right leading-tight tracking-wide">CONSISTENCY<br>IS THE<br>KEY</div>
            </div>
        </div>

        <div onclick="openGymModal()" class="glass-card card-green cursor-pointer p-6 active:scale-98 transition-transform">
            <div class="emoji-watermark">üèãüèª</div>
            <div class="z-content flex justify-between items-center">
                <div class="flex-1 pr-4">
                    <h2 class="text-2xl font-black italic tracking-tighter uppercase text-white mb-2">Gym Workout</h2>
                    <div id="todayPreview" class="text-[10px] font-bold text-emerald-200 uppercase tracking-[0.2em]"></div>
                </div>
                <div class="relative w-16 h-16 shrink-0">
                    <svg class="w-full h-full -rotate-90">
                        <circle cx="32" cy="32" r="28" stroke="rgba(255,255,255,0.1)" stroke-width="6" fill="transparent" />
                        <circle id="circleRing" cx="32" cy="32" r="28" stroke="#10b981" stroke-width="6" fill="transparent" class="transition-all duration-700" stroke-dasharray="175" stroke-dashoffset="175" stroke-linecap="round"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center"><span id="gymPercent" class="text-[10px] font-bold text-white">0%</span></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div onclick="openCoreModal('general')" class="glass-card card-purple flex flex-col justify-between h-36 cursor-pointer p-5 pl-6 active:scale-95 transition-transform">
                <div class="emoji-watermark">‚ö°</div>
                <div class="z-content">
                    <span class="text-[10px] font-bold tracking-[0.2em] uppercase text-purple-200/70 block mb-1">DAILY</span>
                    <span class="text-2xl font-black text-white">CORE</span>
                </div>
                <div class="z-content w-full bg-black/30 h-1.5 rounded-full overflow-hidden"><div id="coreProgressBar" class="bg-purple-400 h-full w-0 transition-all duration-500"></div></div>
                <div class="z-content flex items-center gap-1 text-[9px] font-bold text-purple-200/60">ROUTINE</div>
            </div>

            <div onclick="openCoreModal('abs')" class="glass-card card-pink flex flex-col justify-between h-36 cursor-pointer p-5 pl-6 active:scale-95 transition-transform">
                <div class="emoji-watermark">üéØ</div>
                <div class="z-content">
                    <span class="text-[10px] font-bold tracking-[0.2em] uppercase text-pink-200/70 block mb-1">TRAINING</span>
                    <span class="text-2xl font-black text-white">ABS</span>
                </div>
                <div class="z-content w-full bg-black/30 h-1.5 rounded-full overflow-hidden"><div id="absProgressBar" class="bg-pink-400 h-full w-0 transition-all duration-500"></div></div>
                <div class="z-content flex items-center gap-1 text-[9px] font-bold text-pink-200/60">LEVELS</div>
            </div>
        </div>

        <div onclick="openLibraryModal()" class="glass-card card-gold w-full p-6 cursor-pointer active:scale-98 transition-transform">
             <div class="emoji-watermark">ü¶æ</div>
             <div class="z-content flex justify-between items-center">
                <div>
                    <span class="text-[10px] font-bold tracking-[0.2em] uppercase text-yellow-200/70 block mb-1">REFERENCE</span>
                    <span class="text-2xl font-black text-white">ALL EXERCISES</span>
                </div>
             </div>
        </div>

        <div onclick="openWeightModal()" class="glass-card card-ocean w-full p-6 cursor-pointer active:scale-98 transition-transform">
            <div class="emoji-watermark">üìâ</div>
            <div class="z-content flex justify-between items-center">
                <div>
                    <span class="text-[10px] font-bold tracking-[0.2em] uppercase text-blue-200/70">BODY WEIGHT</span>
                    <div class="flex items-baseline mt-1"><span id="displayWeight" class="text-3xl font-black text-white tracking-tighter">--</span><span class="text-xs font-bold text-blue-200/60 ml-1">KG</span></div>
                </div>
                <div class="w-10 h-10 bg-black/20 border border-white/10 rounded-full flex items-center justify-center text-white/50"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-[110] bg-black/90 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass-card w-full max-w-sm p-6 border border-[#333]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black text-white uppercase tracking-tight">Data Management</h3>
                <button onclick="document.getElementById('settingsModal').classList.add('hidden'); document.getElementById('settingsModal').classList.remove('flex');" class="w-8 h-8 rounded-full bg-[#222] text-white flex items-center justify-center">‚úï</button>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="backupData()" class="w-full py-4 bg-blue-600 rounded-xl font-bold text-white uppercase tracking-widest text-sm shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Backup Data (Download)
                </button>
                <div class="relative">
                    <input type="file" id="restoreFile" onchange="restoreData(this)" class="hidden" accept=".json">
                    <button onclick="document.getElementById('restoreFile').click()" class="w-full py-4 bg-[#222] border border-[#333] rounded-xl font-bold text-slate-300 uppercase tracking-widest text-sm shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Restore Data (Upload)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="fullscreenTimer" class="fixed inset-0 z-[200] hidden flex-col items-center justify-center overflow-hidden touch-none overscroll-none bg-black/90 backdrop-blur-xl transition-all duration-500 gap-10">
        <button onclick="resetTimer()" class="absolute top-8 right-8 w-12 h-12 bg-white/5 rounded-full border border-white/10 flex items-center justify-center active:scale-90 transition-transform z-50 backdrop-blur-md">
            <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>

        <div class="w-full text-center z-20">
            <h2 id="timerTitle" class="text-4xl font-black text-white tracking-[0.2em] uppercase drop-shadow-2xl opacity-90 text-center">RESTING</h2>
        </div>

        <div class="flex-shrink-0 flex items-center justify-center relative">
            <div id="timerContainer" class="relative w-80 h-80 flex items-center justify-center hidden">
                <svg class="w-full h-full absolute inset-0 drop-shadow-[0_0_20px_rgba(59,130,246,0.4)]" viewBox="0 0 320 320">
                    <defs>
                        <linearGradient id="movingGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#3b82f6"/>
                            <stop offset="100%" stop-color="#8b5cf6"/>
                        </linearGradient>
                    </defs>

                    <circle cx="160" cy="160" r="140" stroke="rgba(255,255,255,0.05)" stroke-width="12" fill="transparent"/>

                    <circle id="timerProgressRing" cx="160" cy="160" r="140" 
                            stroke="url(#movingGradient)" 
                            stroke-width="12" 
                            fill="transparent" 
                            stroke-dasharray="879.6" 
                            stroke-dashoffset="0" 
                            stroke-linecap="round" 
                            style="transform-origin: center; transform: scaleX(-1) rotate(-90deg); transition: stroke-dashoffset 0.1s linear;"
                            />
                </svg>

                <div class="absolute inset-0 flex items-center justify-center z-20">
                    <span id="overlayTimerDisplay" class="text-7xl font-black text-white tracking-tighter font-mono">00:00</span>
                </div>
            </div>

            <div id="restSelector" class="hidden w-full max-w-sm grid grid-cols-2 gap-4 z-30 px-4">
                 <button onclick="startTimerInterval(30, 'RESTING'); hideRestSelector()" class="glass-card bg-white/5 border border-white/10 text-white font-black text-3xl py-8 rounded-3xl active:scale-95 transition-all shadow-lg hover:bg-white/10">30s</button>
                 <button onclick="startTimerInterval(60, 'RESTING'); hideRestSelector()" class="glass-card bg-white/5 border border-white/10 text-white font-black text-3xl py-8 rounded-3xl active:scale-95 transition-all shadow-lg hover:bg-white/10">1m</button>
                 <button onclick="startTimerInterval(90, 'RESTING'); hideRestSelector()" class="glass-card bg-white/5 border border-white/10 text-white font-black text-3xl py-8 rounded-3xl active:scale-95 transition-all shadow-lg hover:bg-white/10">1.5m</button>
                 <button onclick="startTimerInterval(120, 'RESTING'); hideRestSelector()" class="glass-card bg-white/5 border border-white/10 text-white font-black text-3xl py-8 rounded-3xl active:scale-95 transition-all shadow-lg hover:bg-white/10">2m</button>
            </div>
        </div>

        <div id="timerStopButton" class="w-full flex justify-center pb-10 hidden">
             <button onclick="resetTimer()" class="px-10 py-4 rounded-full bg-red-600/20 border border-red-500/50 text-red-400 font-bold tracking-widest uppercase hover:bg-red-600 hover:text-white transition-all active:scale-95">STOP TIMER</button>
        </div>
    </div>

    <div id="workoutModal" class="fixed inset-0 z-50 hidden flex flex-col modal-bg transition-opacity duration-300">
        <div class="p-4 flex-shrink-0 flex justify-between items-center border-b border-[#222] bg-black z-50">
            <button id="btnLibraryBack" onclick="openLibraryModal()" class="hidden w-10 h-10 rounded-full bg-[#111] border border-[#222] text-gray-300 flex items-center justify-center mr-2 active:bg-[#1a1a1a]">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <div class="mr-auto">
                <div class="grad-pill px-5 py-2 rounded-full border border-white/20"><span id="modalDay" class="text-sm font-black uppercase tracking-widest text-white drop-shadow-md"></span></div>
            </div>
            <div class="flex items-center gap-2">
                <button id="btnHistory" onclick="openHistoryModal()" class="w-10 h-10 rounded-full bg-[#111] border border-[#222] flex items-center justify-center active:scale-90 transition-transform">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <defs><linearGradient id="iconGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#22d3ee"/><stop offset="100%" stop-color="#c084fc"/></linearGradient></defs>
                        <path stroke="url(#iconGrad)" stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </button>
                <button onclick="showRestSelector()" class="h-10 pl-3 pr-4 rounded-full bg-[#111] border border-[#222] text-slate-300 flex items-center gap-2 active:bg-[#1a1a1a]">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span class="text-[10px] font-black tracking-widest">REST</span>
                </button>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-[#111] border border-[#222] text-slate-300 flex items-center justify-center font-bold active:bg-[#1a1a1a]">‚úï</button>
            </div>
        </div>
        <div class="p-4 overflow-y-auto flex-grow pb-20 relative">
             <div id="modalTabs" class="flex gap-2 mb-6 relative z-10"></div>
             <div id="modalExercises" class="flex flex-col gap-4 relative z-10"></div>
        </div>
    </div>

    <div id="historyModal" class="fixed inset-0 z-[60] hidden flex flex-col modal-bg">
        <div class="p-6 flex-shrink-0 flex justify-between items-center border-b border-[#222] bg-black">
            <h2 class="text-lg font-black uppercase text-white tracking-tight">History Log</h2>
            <button onclick="document.getElementById('historyModal').classList.add('hidden'); document.getElementById('historyModal').classList.remove('flex');" class="w-10 h-10 rounded-full bg-[#1a1a1a] text-white flex items-center justify-center font-bold hover:bg-[#222]">‚úï</button>
        </div>
        <div class="p-6 overflow-y-auto flex-grow pb-32 relative">
             <div id="historyLogContainer" class="flex flex-col gap-6 relative z-10"></div>
        </div>
    </div>

    <div id="weightModal" class="fixed inset-0 z-50 hidden flex flex-col modal-bg theme-blue">
        <div class="p-6 flex-shrink-0 flex justify-between items-center border-b border-[#222] bg-black"><h2 class="text-lg font-black uppercase text-white">Report</h2><button onclick="document.getElementById('weightModal').classList.add('hidden'); document.getElementById('weightModal').classList.remove('flex');" class="w-10 h-10 rounded-full bg-[#1a1a1a] text-white flex items-center justify-center font-bold hover:bg-[#222]">‚úï</button></div>
        <div class="p-6 overflow-y-auto flex-grow pb-20 relative">
            <svg class="modal-watermark" style="opacity:0.02;" viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
            <div class="grid grid-cols-3 gap-3 mb-6 relative z-10">
                <div class="glass-card p-3 rounded-xl flex flex-col items-center"><span class="text-[9px] font-bold text-gray-500 uppercase">Current</span><span id="statCurrent" class="text-lg font-black text-white mt-1">--</span></div>
                <div class="glass-card p-3 rounded-xl flex flex-col items-center"><span class="text-[9px] font-bold text-gray-500 uppercase">Start</span><span id="statStart" class="text-lg font-black text-white mt-1">--</span></div>
                <div class="glass-card p-3 rounded-xl flex flex-col items-center"><span class="text-[9px] font-bold text-gray-500 uppercase">Change</span><span id="statChange" class="text-lg font-black text-green-500 mt-1">--</span></div>
            </div>
            <div class="glass-card rounded-2xl p-5 mb-8 relative overflow-hidden z-10">
                <div class="flex justify-between items-start mb-6 relative z-10">
                    <div><h3 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">CURRENT WEIGHT</h3><span id="modalCurrentWeight" class="text-3xl font-black text-white tracking-tight">--</span></div>
                    <button onclick="document.getElementById('addWeightSection').classList.toggle('hidden')" class="w-10 h-10 bg-blue-600 rounded-lg text-white flex items-center justify-center shadow-lg active:scale-95"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button>
                </div>
                <div id="addWeightSection" class="hidden mb-6 bg-[#111] p-4 rounded-xl border border-[#222]"><div class="flex gap-3"><input type="date" id="weightDateInput" class="flex-1 glass-input-styled rounded-lg p-3 font-bold text-sm"><input type="number" id="newWeightInput" placeholder="KG" class="w-24 glass-input-styled rounded-lg p-3 font-black text-center"></div><button onclick="logNewWeight()" class="w-full mt-3 bg-blue-600 text-white py-3 rounded-lg font-bold uppercase text-xs tracking-widest">Update Log</button></div>
                <div class="relative w-full h-48"><div id="chartBubble" class="absolute bg-[#222] text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-xl -translate-x-1/2 -translate-y-full transition-all duration-500 border border-[#333]" style="left: 50%; top: 50%;">--</div><svg id="weightChart" class="w-full h-full overflow-visible" preserveAspectRatio="none"><defs><linearGradient id="chartFill" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.4"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0"/></linearGradient></defs><path id="chartArea" d="" fill="url(#chartFill)" /><path id="chartLine" d="" fill="none" stroke="#3b82f6" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" /><g id="chartDots"></g></svg></div>
            </div>
            <h3 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 relative z-10">HISTORY</h3>
            <div id="historyList" class="flex flex-col gap-0 relative pb-10 z-10"></div>
        </div>
    </div>

    <div id="deleteModal" class="fixed inset-0 z-[80] bg-black/80 hidden items-center justify-center"><div class="glass-card p-6 rounded-2xl shadow-2xl max-w-xs w-full text-center border border-[#333]"><h3 class="text-lg font-black text-white mb-4">Delete Entry?</h3><div class="flex gap-3"><button onclick="document.getElementById('deleteModal').classList.add('hidden'); document.getElementById('deleteModal').classList.remove('flex');" class="flex-1 py-3 bg-[#222] text-white rounded-xl font-bold">Cancel</button><button onclick="confirmDelete()" class="flex-1 py-3 bg-red-600 rounded-xl font-bold text-white">Delete</button></div></div></div>

    <script>
        const today = new Date();
        const days = ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
        const dayName = days[today.getDay()];
        const dateKey = today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, '0') + "-" + String(today.getDate()).padStart(2, '0');

        const workouts = {
            'MONDAY': { tabs: ['Chest', 'Triceps'], ex: [['Barbell Bench Press', 'Incline Dumbbell Press', 'Cable Crossover', 'Dumbbell Pullover'], ['Skullcrushers', 'Rope Pushdown', 'Overhead Extension', 'Dips']] },
            'TUESDAY': { tabs: ['Back', 'Biceps'], ex: [['Lat Pulldown', 'Barbell Row', 'Single Arm Dumbbell Row', 'Face Pulls'], ['Barbell Curl', 'Hammer Curl', 'Incline Dumbbell Curl']] },
            'WEDNESDAY': { tabs: ['Legs', 'Shoulders'], ex: [['Squats (Barbell/Hack)', 'Leg Press', 'Romanian Deadlift', 'Leg Extensions', 'Standing Calf Raise'], ['Overhead Press', 'Lateral Raises', 'Rear Delt Fly']] },
            'THURSDAY': { tabs: ['Chest Var', 'Triceps Var'], ex: [['Dumbbell Bench Press', 'Machine Chest Press', 'Pec Deck Fly', 'Weighted Push-ups'], ['V-Bar Pushdown', 'French Press', 'Single Arm Cable Ext']] },
            'FRIDAY': { tabs: ['Back Var', 'Biceps Var'], ex: [['Pull-Ups (or Assisted)', 'Seated Cable Row', 'Lat Pulldown (Close Grip)', 'Straight Arm Pulldown'], ['Preacher Curl', 'Cable Curl', 'Reverse Curl']] },
            'SATURDAY': { tabs: ['Legs Var', 'Shoulders Var'], ex: [['Deadlift (or RDL)', 'Walking Lunges', 'Leg Curls', 'Seated Calf Raise'], ['Arnold Press', 'Cable Lateral Raise', 'Face Pull']] },
            'SUNDAY': { tabs: ['Rest', 'Recovery'], ex: [[], []] }
        };

        const coreExercises = {
            'Core': [ { name: 'Hanging Knee Raises', sets: 4, reps: '12-15' }, { name: 'Cable Crunch', sets: 4, reps: '15-20' }, { name: 'Plank', time: '60s', sets: 3, seconds: 60 }, { name: 'Woodchoppers', sets: 3, reps: '15' } ],
            'Mobility': [ { name: 'Cat-Cow Stretch', time: '60s', sets: 2, seconds: 60 }, { name: 'Thoracic Extension', time: '60s', sets: 2, seconds: 60 }, { name: 'Hip Flexor Stretch', time: '45s', sets: 2, seconds: 45 } ],
            'Finisher': [ { name: 'HIIT Sprints / Battle Rope', time: '10 min', sets: 1, seconds: 600 } ]
        };
        
        const absLevels = {
            'beginner': [ { name: 'Jumping Jacks', time: '00:30', seconds: 30 }, { name: 'Mountain Climbers', reps: '20' }, { name: 'Heel Touch', reps: '20' }, { name: 'Cobra Stretch', time: '00:30', seconds: 30 } ],
            'intermediate': [ { name: 'Crunches', reps: '20' }, { name: 'Leg Raises', reps: '15' }, { name: 'Flutter Kicks', time: '00:30', seconds: 30 }, { name: 'Plank Jacks', reps: '15' } ],
            'advanced': [ { name: 'Bicycle Crunches', reps: '24' }, { name: 'V-Ups', reps: '15' }, { name: 'Hollow Body', time: '00:45', seconds: 45 }, { name: 'Dead Bug', reps: '20' } ]
        };

        let currentTab = 0, streak = 0, streakLocked = false;
        let userName = "USER";
        let exerciseData = {}; weightHistory = []; deleteIndex = -1; 
        let isCoreMode = false;
        let isLibraryMode = false;
        let libraryData = {}; 
        let activeAbsLevel = null;
        let absViewMode = 'levels'; 
        let activeCoreTab = 'Core'; 

        let timerInterval = null; let timerEndTime = null; let timerTotalDuration = 0;
        let timerTargetExercise = null; 
        let wakeLock = null;

        async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.log(err); } }
        async function releaseWakeLock() { if (wakeLock !== null) { await wakeLock.release(); wakeLock = null; } }
        if ("Notification" in window) { Notification.requestPermission(); }

        // --- UI FUNCTIONS ---
        function showRestSelector() {
            document.getElementById('fullscreenTimer').classList.remove('hidden'); document.getElementById('fullscreenTimer').classList.add('flex');
            document.getElementById('restSelector').classList.remove('hidden'); document.getElementById('restSelector').classList.add('grid');
            document.getElementById('timerContainer').classList.add('hidden'); 
            document.getElementById('timerStopButton').classList.add('hidden'); // Hide stop button in selection mode
            document.getElementById('timerTitle').innerText = "SELECT REST";
        }
        function hideRestSelector() {
            document.getElementById('restSelector').classList.add('hidden'); document.getElementById('restSelector').classList.remove('grid');
            document.getElementById('timerContainer').classList.remove('hidden');
            document.getElementById('timerStopButton').classList.remove('hidden'); // Show stop button in active mode
        }
        
        // --- CORE TIMER LOGIC ---
        function startTimerInterval(customSeconds, labelText = "") {
            timerTotalDuration = customSeconds; timerEndTime = Date.now() + (customSeconds * 1000); 
            timerTargetExercise = labelText; saveData(); requestWakeLock(); 
            const titleEl = document.getElementById("timerTitle");
            if (labelText) { titleEl.innerText = labelText.toUpperCase(); } else { titleEl.innerText = "RESTING"; }
            document.getElementById('fullscreenTimer').classList.remove('hidden'); document.getElementById('fullscreenTimer').classList.add('flex');
            checkTimerTick();
            if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(checkTimerTick, 100); 
        }
        
        function checkTimerTick() {
            if(!timerEndTime) return;
            const now = Date.now();
            const remainingMs = timerEndTime - now;
            const remainingSec = Math.ceil(remainingMs / 1000);

            if (remainingSec > 0) {
                const m = Math.floor(remainingSec / 60); const s = remainingSec % 60;
                document.getElementById('overlayTimerDisplay').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                
                // Anti-Clockwise Depletion (Full at 0, Empty at circumference)
                const circumference = 879.6; 
                const totalMs = timerTotalDuration * 1000;
                const elapsed = totalMs - remainingMs;
                const pct = elapsed / totalMs;
                const offset = circumference * pct; // Grows to empty the ring
                
                document.getElementById('timerProgressRing').style.strokeDashoffset = offset;

            } else { finishTimer(); }
        }

        function finishTimer() {
            clearInterval(timerInterval); timerInterval = null; timerEndTime = null; 
            if (isCoreMode && timerTargetExercise) { toggleExerciseComplete(timerTargetExercise); }
            timerTargetExercise = null; saveData(); releaseWakeLock(); 
            confetti({ particleCount: 60, spread: 60, origin: { y: 0.6 }, zIndex: 9999, colors: ['#3b82f6', '#ffffff'] });
            if(navigator.vibrate) navigator.vibrate([600, 300, 600]);
            document.getElementById('fullscreenTimer').classList.add('hidden'); document.getElementById('fullscreenTimer').classList.remove('flex');
        }
        function resetTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null; timerEndTime = null; saveData(); releaseWakeLock();
            document.getElementById('fullscreenTimer').classList.add('hidden'); document.getElementById('fullscreenTimer').classList.remove('flex');
            document.getElementById('restSelector').classList.add('hidden');
        }
        function restoreTimer() {
            if (timerEndTime) {
                const now = Date.now();
                if (timerEndTime > now) { 
                    const remaining = Math.ceil((timerEndTime - now) / 1000);
                    timerTotalDuration = remaining + 1; 
                    document.getElementById('restSelector').classList.add('hidden');
                    document.getElementById('timerContainer').classList.remove('hidden');
                    document.getElementById('timerStopButton').classList.remove('hidden');
                    const savedTarget = timerTargetExercise;
                    startTimerInterval(remaining, savedTarget || "RESUMED");
                } else { timerEndTime = null; saveData(); }
            }
        }

        // --- APP LOGIC ---
        function init() {
            loadData();
            document.getElementById('todayPreview').innerText = workouts[dayName].tabs.length ? `${workouts[dayName].tabs[0]} & ${workouts[dayName].tabs[1]}` : "REST";
            document.getElementById('userNameInput').value = userName;
            document.getElementById('weightDateInput').valueAsDate = new Date();
            calcTotalProgress(); updateCoreProgress(); refreshWeightUI(); restoreTimer(); cleanOldHistory();
        }

        function cleanOldHistory() {
            const historyMap = {}; 
            Object.keys(exerciseData).filter(k => k.match(/^\d{4}-\d{2}-\d{2}$/)).forEach(date => {
                const dayIdx = new Date(date).getDay();
                if(!historyMap[dayIdx]) historyMap[dayIdx] = [];
                historyMap[dayIdx].push(date);
            });
            let changed = false;
            for(let dayIdx in historyMap) {
                const dates = historyMap[dayIdx].sort((a,b) => new Date(b) - new Date(a)); 
                if (dates.length > 4) {
                    const toRemove = dates.slice(4); toRemove.forEach(d => { delete exerciseData[d]; changed = true; });
                }
            }
            if(changed) saveData();
        }

        function saveData() {
            const data = { date: dateKey, user: document.getElementById('userNameInput').value, exerciseData: exerciseData, weightHistory: weightHistory, streak: streak, streakLocked: streakLocked, timerEndTime: timerEndTime, timerTargetExercise: timerTargetExercise };
            try { localStorage.setItem('fitnessProFinal', JSON.stringify(data)); } catch(e) {}
        }

        function loadData() {
            const raw = localStorage.getItem('fitnessProFinal');
            if(raw) {
                const data = JSON.parse(raw);
                userName = data.user || "USER"; 
                exerciseData = data.exerciseData || {}; weightHistory = data.weightHistory || []; streak = data.streak || 0;
                timerEndTime = data.timerEndTime || null; timerTargetExercise = data.timerTargetExercise || null; 
                if(data.date === dateKey) { streakLocked = data.streakLocked || false; } else { streakLocked = false; saveData(); }
            }
        }

        function backupData() {
            const raw = localStorage.getItem('fitnessProFinal');
            if (!raw) { alert("No data to backup!"); return; }
            try {
                const parsed = JSON.parse(raw);
                const formatted = JSON.stringify(parsed, null, 4); 
                const blob = new Blob([formatted], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fitness_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch(e) { alert("Error preparing backup."); }
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const parsed = JSON.parse(content);
                    if (!parsed.exerciseData) throw new Error("Invalid file");
                    localStorage.setItem('fitnessProFinal', JSON.stringify(parsed));
                    alert("Data restored successfully! App will reload.");
                    location.reload();
                } catch(err) { alert("Error restoring file: Invalid Format"); }
            };
            reader.readAsText(file);
        }

        function updateCoreProgress() {
            const allCoreEx = [...coreExercises['Core'], ...coreExercises['Mobility'], ...coreExercises['Finisher']];
            let coreTotal = allCoreEx.length; let coreDone = 0;
            allCoreEx.forEach(exObj => { const exName = exObj.name; if(exerciseData[dateKey] && exerciseData[dateKey][exName] && exerciseData[dateKey][exName].completed) { coreDone++; } });
            const percentage = coreTotal === 0 ? 0 : (coreDone / coreTotal * 100);
            document.getElementById('coreProgressBar').style.width = percentage + '%';
            
            let absTotal = 3; let absDone = 0;
            if (activeAbsLevel) {
               absLevels[activeAbsLevel].forEach(ex => { if(exerciseData[dateKey] && exerciseData[dateKey][ex.name] && exerciseData[dateKey][ex.name].completed) absDone++; });
               document.getElementById('absProgressBar').style.width = (absDone / absLevels[activeAbsLevel].length * 100) + '%';
            } else {
               if (exerciseData[dateKey] && exerciseData[dateKey].absChoice) {
                   const choice = exerciseData[dateKey].absChoice;
                   absLevels[choice].forEach(ex => { if(exerciseData[dateKey] && exerciseData[dateKey][ex.name] && exerciseData[dateKey][ex.name].completed) absDone++; });
                   document.getElementById('absProgressBar').style.width = (absDone / absLevels[choice].length * 100) + '%';
               } else { document.getElementById('absProgressBar').style.width = '0%'; }
            }
        }

        function addNewSet(exName) {
            let source = isLibraryMode ? libraryData : exerciseData[dateKey];
            if (!source) { source = {}; if(isLibraryMode) libraryData=source; else exerciseData[dateKey]=source; }
            if(!source[exName]) { source[exName] = { sets: [{w:'',r:''}], completed: false }; }
            source[exName].sets.push({w:'',r:''});
            if(!isLibraryMode) saveData();
            
            if (isCoreMode && activeAbsLevel) { renderExercises(absLevels[activeAbsLevel]); } else if (isCoreMode && !activeAbsLevel) { renderExercises(coreExercises[activeCoreTab]); } else { if(isLibraryMode) { switchLibraryTab(currentTab); } else { renderExercises(workouts[dayName].ex[currentTab]); } }
        }

        function renderExercises(list, container = document.getElementById('modalExercises')) {
            if(!isLibraryMode) container.innerHTML = "";
            let source = isLibraryMode ? libraryData : (exerciseData[dateKey] || {});
            list.forEach((exObj) => {
                const name = typeof exObj === 'object' ? exObj.name : exObj;
                const timeStr = typeof exObj === 'object' && exObj.time ? exObj.time : null;
                const seconds = typeof exObj === 'object' && exObj.seconds ? exObj.seconds : 0;
                let ex = source[name];
                if (!ex) { ex = { sets: [{w:'',r:''}], completed: false }; }
                if (!ex.sets || ex.sets.length === 0) ex.sets = [{w:'',r:''}];
                
                let videoBtn = '';
                const ytSearch = `https://www.youtube.com/results?search_query=${encodeURIComponent(name + " exercise tutorial")}`;
                videoBtn = `<a href="${ytSearch}" target="_blank" class="action-pill pill-video">‚ñ∂ VIDEO</a>`;

                let timerBtn = '';
                if (timeStr) { timerBtn = `<div onclick="startTimerInterval(${seconds}, '${name}'); hideRestSelector(); document.getElementById('timerContainer').classList.remove('hidden'); event.stopPropagation();" class="action-pill pill-timer">‚è± ${timeStr}</div>`; }
                let historyBtn = !activeAbsLevel && !isLibraryMode ? `<div id="compare-${name.replace(/[\s\/]/g, '')}" class="action-pill pill-compare" onclick="showHistory('${name}')">üìä HISTORY</div>` : '';
                
                let contentHTML = '';
                if (isCoreMode && activeAbsLevel) { } else {
                    ex.sets.forEach((set, i) => { contentHTML += `<div class="flex items-center gap-3 mb-2"><span class="text-[10px] font-bold text-slate-500 w-6">SET ${i+1}</span><div class="flex items-center flex-1 rounded-lg overflow-hidden gap-1"><input type="number" placeholder="KG" value="${set.w}" oninput="logSet('${name}', ${i}, 'w', this.value)" class="glass-input-styled w-1/2 p-2 text-center text-sm font-bold placeholder:text-slate-600 rounded-lg"><input type="number" placeholder="REPS" value="${set.r}" oninput="logSet('${name}', ${i}, 'r', this.value)" class="glass-input-styled w-1/2 p-2 text-center text-sm font-bold placeholder:text-slate-600 rounded-lg"></div></div>`; });
                    contentHTML += `<div class="flex justify-center mt-3"><button onclick="addNewSet('${name}')" class="w-8 h-8 rounded-full bg-white/5 border border-white/10 text-white/50 flex items-center justify-center hover:bg-white/20 transition-all active:scale-90"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg></button></div>`;
                }
                const isChecked = ex.completed; const checkClass = isChecked ? "checked" : ""; const checkIcon = isChecked ? '<svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>' : '';
                
                const card = document.createElement('div'); card.className = "modal-exercise-card p-5 rounded-2xl relative overflow-hidden transition-all duration-300 layer-boost mb-4";
                card.innerHTML = `<div class="flex justify-between items-start mb-4"><div class="flex flex-col gap-2"><h4 class="font-black text-white text-lg uppercase tracking-tight leading-none">${name}</h4><div class="flex flex-wrap gap-2">${videoBtn} ${historyBtn} ${timerBtn}</div></div><div onclick="toggleExerciseComplete('${name}')"><div class="neon-checkbox ${checkClass}">${checkIcon}</div></div></div>${contentHTML}`;
                container.appendChild(card);
            });
        }

        function logSet(exName, setIdx, field, val) {
            let source;
            if (isLibraryMode) { source = libraryData; } else { if(!exerciseData[dateKey]) exerciseData[dateKey] = {}; source = exerciseData[dateKey]; }
            if(!source[exName]) { source[exName] = { sets: [{w:'',r:''}], completed: false }; }
            while(source[exName].sets.length <= setIdx) { source[exName].sets.push({w:'', r:''}); }
            source[exName].sets[setIdx][field] = val;
            if(!isLibraryMode) { if(val) { if(!exerciseData.history) exerciseData.history = {}; exerciseData.history[exName] = JSON.parse(JSON.stringify(source[exName].sets)); } saveData(); }
        }

        function showHistory(exName) {
            const target = document.getElementById(`compare-${exName.replace(/[\s\/]/g, '')}`);
            const hist = exerciseData.history ? exerciseData.history[exName] : null;
            if(hist && Array.isArray(hist)) { const txt = hist.map(s => (s.w && s.r) ? `${s.w}x${s.r}` : '').filter(Boolean).join(' | '); alert("PREVIOUS: " + txt); } else { alert("No previous data found."); }
        }

        function toggleExerciseComplete(exName) {
            let source;
            if (isLibraryMode) { source = libraryData; } else { if(!exerciseData[dateKey]) exerciseData[dateKey] = {}; source = exerciseData[dateKey]; }
            if(!source[exName]) { source[exName] = { sets: [{w:'',r:''}], completed: false }; }
            if (timerTargetExercise === exName && isCoreMode) { source[exName].completed = true; } else { source[exName].completed = !source[exName].completed; }
            if(source[exName].completed) { if(navigator.vibrate) navigator.vibrate(50); confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 }, colors: ['#22c55e', '#ffffff'] }); }
            if(!isLibraryMode) saveData();
            if(isLibraryMode) { switchLibraryTab(currentTab); } else if(isCoreMode) { if (activeAbsLevel) { renderExercises(absLevels[activeAbsLevel]); updateCoreProgress(); } else if (currentTab === 'level_select') {} else { renderExercises(coreExercises[activeCoreTab]); updateCoreProgress(); } } else { renderExercises(workouts[dayName].ex[currentTab]); calcTotalProgress(); }
        }

        function calcTotalProgress() {
            if(!exerciseData[dateKey]) { updateCircle(0); return; }
            let total = 0, done = 0;
            const w = workouts[dayName]; if(!w.ex[0]) return;
            const allEx = [...w.ex[0], ...w.ex[1]];
            allEx.forEach(ex => { total++; if(exerciseData[dateKey][ex] && exerciseData[dateKey][ex].completed) done++; });
            const pct = total === 0 ? 0 : Math.round((done / total) * 100);
            updateCircle(pct);
            if(done === total && total > 0 && !streakLocked) { streak++; streakLocked = true; saveData(); }
            document.getElementById('streakCount').innerText = streak;
        }

        function updateCircle(pct) { document.getElementById('circleRing').style.strokeDashoffset = 175 - (175 * pct / 100); document.getElementById('gymPercent').innerText = pct + "%"; }
        function openWeightModal() { document.getElementById('weightModal').classList.remove('hidden'); document.getElementById('weightModal').classList.add('flex'); setTimeout(() => { refreshWeightUI(); }, 50); }
        function logNewWeight() {
            const wInput = document.getElementById('newWeightInput');
            const dInput = document.getElementById('weightDateInput');
            const val = parseFloat(wInput.value); if(!val || val <= 0) { alert("Please enter a valid weight"); return; }
            let dateTs = Date.now(); if(dInput.value) { const d = new Date(dInput.value); d.setHours(12,0,0,0); dateTs = d.getTime(); }
            weightHistory.push({date: dateTs, weight: val}); saveData(); refreshWeightUI(); wInput.value = ""; document.getElementById('addWeightSection').classList.add('hidden');
        }

        function refreshWeightUI() {
            if(!weightHistory || weightHistory.length === 0) { 
                document.getElementById('historyList').innerHTML = "<div class='text-center text-gray-600 mt-10 text-xs font-bold tracking-widest'>NO HISTORY YET</div>"; 
                document.getElementById('statCurrent').innerText = "--"; document.getElementById('statStart').innerText = "--"; document.getElementById('statChange').innerText = "--";
                document.getElementById('chartArea').setAttribute('d', ''); document.getElementById('chartLine').setAttribute('d', ''); document.getElementById('chartDots').innerHTML = ''; return; 
            }
            const sorted = [...weightHistory].sort((a,b) => a.date - b.date);
            const latest = sorted[sorted.length-1].weight; const start = sorted[0].weight; const change = latest - start;
            document.getElementById('displayWeight').innerText = latest; document.getElementById('modalCurrentWeight').innerText = latest + " KG";
            document.getElementById('statCurrent').innerText = latest; document.getElementById('statStart').innerText = start;
            const changeEl = document.getElementById('statChange'); changeEl.innerText = (change > 0 ? "+" : "") + change.toFixed(1); changeEl.className = "text-lg font-black mt-1 " + (change <= 0 ? "text-green-500" : "text-red-500");
            const svgWidth = 100; const svgHeight = 50; const padding = 5;
            let minW = Math.min(...sorted.map(i => i.weight)); let maxW = Math.max(...sorted.map(i => i.weight)); if(minW === maxW) { minW -= 5; maxW += 5; } 
            const timeStart = sorted[0].date; const timeEnd = sorted[sorted.length-1].date; const timeRange = timeEnd - timeStart || 1; 
            const getX = (t) => ((t - timeStart) / timeRange) * (svgWidth - (padding*2)) + padding;
            const getY = (w) => svgHeight - padding - (((w - minW) / (maxW - minW)) * (svgHeight - (padding*2)));
            let points = sorted.map(item => `${getX(item.date)},${getY(item.weight)}`);
            let linePath = "M" + points.join(" L"); let areaPath = linePath + ` L${getX(sorted[sorted.length-1].date)},${svgHeight} L${getX(sorted[0].date)},${svgHeight} Z`;
            document.getElementById('chartArea').setAttribute('d', areaPath); document.getElementById('chartLine').setAttribute('d', linePath);
            const dotsContainer = document.getElementById('chartDots'); dotsContainer.innerHTML = sorted.map(item => `<circle cx="${getX(item.date)}" cy="${getY(item.weight)}" r="1.5" fill="#3b82f6" stroke="#111" stroke-width="0.5" />`).join('');
            renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('historyList'); list.innerHTML = "";
            const sorted = [...weightHistory].sort((a,b) => b.date - a.date);
            sorted.forEach((item) => {
                const idx = weightHistory.indexOf(item); const d = new Date(item.date).toLocaleDateString('en-US', {month:'short', day:'numeric'});
                list.innerHTML += `<div class="history-item relative pl-8 pb-4"><div class="history-line"></div><div class="absolute left-2 top-[18px] w-2.5 h-2.5 rounded-full bg-blue-400 ring-4 ring-white/10 z-10"></div><div class="glass-card p-3 rounded-2xl flex justify-between items-center transition-colors hover:bg-white/10"><span class="text-xs font-bold text-slate-500 tracking-wide">${d}</span><div class="flex items-center gap-3"><span class="text-lg font-black text-white">${item.weight} <span class="text-xs text-slate-500">KG</span></span><button onclick="requestDelete(${idx})" class="w-8 h-8 flex items-center justify-center text-red-400 bg-red-500/10 rounded-full hover:bg-red-500 hover:text-white transition-all active:scale-90">‚úï</button></div></div></div>`;
            });
        }
        function openHistoryModal() {
            const container = document.getElementById('historyLogContainer'); container.innerHTML = "";
            const dates = Object.keys(exerciseData).filter(k => k.match(/^\d{4}-\d{2}-\d{2}$/)).sort((a,b) => new Date(b) - new Date(a));
            if (dates.length === 0) { container.innerHTML = "<div class='text-center text-slate-500 font-bold mt-10'>NO WORKOUTS LOGGED</div>"; } else {
                dates.forEach(d => {
                    const dateObj = new Date(d); const dayNameHist = days[dateObj.getDay()]; const prettyDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); const dayData = exerciseData[d];
                    let muscleTitle = "REST DAY"; if(workouts[dayNameHist] && workouts[dayNameHist].tabs.length) { muscleTitle = workouts[dayNameHist].tabs.join(' & ').replace(/ Var/g, ''); }
                    let dayExercisesHTML = "";
                    for (const [name, data] of Object.entries(dayData)) {
                        const allAbs = Object.values(absLevels).flat().map(a=>a.name);
                        const validSets = data.sets ? data.sets.filter(s => s.w && s.r) : [];
                        if (validSets.length === 0 && !data.completed) continue; 
                        let setsHTML = "";
                        if(validSets.length > 0) { setsHTML = validSets.map(s => `<span class="block text-slate-400 text-xs font-mono ml-2 border-l border-slate-700 pl-2 mt-1">${s.w}kg √ó ${s.r}</span>`).join(''); } else if (data.completed) { setsHTML = `<span class="block text-green-400 text-xs font-mono ml-2 border-l border-slate-700 pl-2 mt-1">COMPLETED</span>`; }
                        dayExercisesHTML += `<div class="mb-4 last:mb-0"><div class="text-sm font-bold text-white mb-1">${name}</div><div class="flex flex-col">${setsHTML}</div></div>`;
                    }
                    if (dayExercisesHTML) { container.innerHTML += `<div class="glass-card p-5 rounded-2xl border border-white/5 mb-4 shadow-lg bg-black/40"><div class="flex justify-between items-center mb-4 pb-3 border-b border-white/10"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center font-bold text-xs border border-blue-500/30">${prettyDate.split(' ')[1]}</div><div class="flex flex-col"><span class="text-xs font-bold text-slate-500 uppercase tracking-widest">${prettyDate.split(' ')[0]}</span><span class="text-sm font-black text-white uppercase tracking-tight">${muscleTitle}</span></div></div></div><div class="flex flex-col">${dayExercisesHTML}</div></div>`; }
                });
            }
            document.getElementById('historyModal').classList.remove('hidden'); document.getElementById('historyModal').classList.add('flex');
        }
        function openGymModal() {
            isCoreMode = false; isLibraryMode = false;
            document.getElementById('btnLibraryBack').classList.add('hidden'); document.getElementById('btnHistory').style.display = 'flex'; 
            document.getElementById('modalDay').innerText = dayName; document.getElementById('modalTabs').classList.remove('hidden'); document.getElementById('modalExercises').innerHTML = ""; 
            const m = document.getElementById('workoutModal'); m.classList.remove('hidden'); m.classList.add('flex'); m.className = "fixed inset-0 z-50 flex flex-col modal-bg theme-green";
            const w = workouts[dayName]; if(!w.tabs.length) { document.getElementById('modalExercises').innerHTML = "<div class='text-white text-center font-bold mt-10'>REST DAY</div>"; return; }
            startMainWorkout();
        }
        function startMainWorkout() {
            document.getElementById('modalDay').innerText = dayName; document.getElementById('modalTabs').classList.remove('hidden');
            document.getElementById('modalTabs').className = "flex p-1 bg-white/5 border border-white/10 rounded-xl mb-6 relative select-none layer-boost";
            const w = workouts[dayName];
            document.getElementById('modalTabs').innerHTML = w.tabs.map((t, i) => {
                const displayName = t.replace(' Var', '');
                const activeClass = "modal-active-tab flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out";
                const inactiveClass = "text-slate-500 hover:text-slate-300 hover:bg-white/5 flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out";
                return `<button onclick="switchTab(${i})" class="${i===0 ? activeClass : inactiveClass}">${displayName}</button>`;
            }).join('');
            switchTab(0);
        }
        function openLibraryModal() {
            isCoreMode = false; isLibraryMode = true; libraryData = {}; 
            document.getElementById('btnLibraryBack').classList.remove('hidden'); document.getElementById('btnHistory').style.display = 'none'; 
            const m = document.getElementById('workoutModal'); m.classList.remove('hidden'); m.classList.add('flex'); m.className = "fixed inset-0 z-50 flex flex-col modal-bg theme-gold";
            document.getElementById('modalDay').innerText = "LIBRARY"; const daysShort = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            document.getElementById('modalTabs').classList.remove('hidden'); document.getElementById('modalTabs').className = "flex p-1 bg-white/5 border border-white/10 rounded-xl mb-6 relative select-none layer-boost";
            document.getElementById('modalTabs').innerHTML = daysShort.map((d, i) => {
                 const activeClass = "modal-active-tab flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out";
                 const inactiveClass = "text-slate-500 hover:text-slate-300 hover:bg-white/5 flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out";
                 return `<button onclick="switchLibraryTab(${i})" class="${i === 0 ? activeClass : inactiveClass}">${d}</button>`;
            }).join('');
            switchLibraryTab(0);
        }
        function switchLibraryTab(idx) {
             currentTab = idx; const dayNames = ['MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY']; const dName = dayNames[idx];
             const btns = document.getElementById('modalTabs').children; const activeClass = "modal-active-tab flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out"; const inactiveClass = "text-slate-500 hover:text-slate-300 hover:bg-white/5 flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out";
             for(let b of btns) b.className = inactiveClass; btns[idx].className = activeClass; 
             const container = document.getElementById('modalExercises'); container.innerHTML = ""; const w = workouts[dName];
             if(w && w.tabs) {
                 w.tabs.forEach((muscleName, i) => {
                     const header = document.createElement('div'); header.className = "muscle-header"; header.innerText = muscleName.replace(' Var', ''); container.appendChild(header);
                     const subContainer = document.createElement('div'); subContainer.className = "flex flex-col gap-4"; container.appendChild(subContainer);
                     renderExercises(w.ex[i], subContainer);
                 });
             }
        }
        function openCoreModal(type) { 
            isCoreMode = true; isLibraryMode = false;
            document.getElementById('btnLibraryBack').classList.add('hidden'); document.getElementById('btnHistory').style.display = 'none'; 
            const m = document.getElementById('workoutModal'); m.classList.remove('hidden'); m.classList.add('flex');
            if (type === 'abs') {
                m.className = "fixed inset-0 z-50 flex flex-col modal-bg theme-pink"; document.getElementById('modalDay').innerText = "ABS LEVEL"; document.getElementById('modalTabs').classList.add('hidden');
                if(!exerciseData[dateKey]) exerciseData[dateKey] = {};
                if (exerciseData[dateKey].absChoice) { selectAbsLevel(exerciseData[dateKey].absChoice); } else {
                    absViewMode = 'levels'; const container = document.getElementById('modalExercises');
                    container.innerHTML = `
                        <div onclick="selectAbsLevel('beginner')" class="glass-card card-green p-6 rounded-3xl mb-4 relative overflow-hidden cursor-pointer active:scale-95 transition-transform"><div class="emoji-watermark">‚ù§Ô∏è‚Äçüî•</div><div class="relative z-10 flex justify-between items-center"><div><h3 class="text-2xl font-black text-white italic tracking-tighter drop-shadow-md">BEGINNER</h3><p class="text-[10px] font-bold text-emerald-200 tracking-[0.2em] uppercase mt-1">LOSE BELLY FAT</p></div><div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center border border-white/10"><span class="text-xl text-white">‚ûî</span></div></div></div>
                        <div onclick="selectAbsLevel('intermediate')" class="glass-card card-ocean p-6 rounded-3xl mb-4 relative overflow-hidden cursor-pointer active:scale-95 transition-transform"><div class="emoji-watermark">‚öîÔ∏è</div><div class="relative z-10 flex justify-between items-center"><div><h3 class="text-2xl font-black text-white italic tracking-tighter drop-shadow-md">INTERMEDIATE</h3><p class="text-[10px] font-bold text-blue-200 tracking-[0.2em] uppercase mt-1">ROCK HARD ABS</p></div><div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center border border-white/10"><span class="text-xl text-white">‚ûî</span></div></div></div>
                        <div onclick="selectAbsLevel('advanced')" class="glass-card card-fire p-6 rounded-3xl mb-4 relative overflow-hidden cursor-pointer active:scale-95 transition-transform"><div class="emoji-watermark">‚ò¢Ô∏è</div><div class="relative z-10 flex justify-between items-center"><div><h3 class="text-2xl font-black text-white italic tracking-tighter drop-shadow-md">ADVANCED</h3><p class="text-[10px] font-bold text-red-200 tracking-[0.2em] uppercase mt-1">SIX PACK ABS</p></div><div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center border border-white/10"><span class="text-xl text-white">‚ûî</span></div></div></div>`;
                }
            } else {
                activeAbsLevel = null; m.className = "fixed inset-0 z-50 flex flex-col modal-bg theme-purple"; document.getElementById('modalDay').innerText = "DAILY CORE"; document.getElementById('modalTabs').classList.remove('hidden');
                document.getElementById('modalTabs').className = "flex p-1 bg-white/5 border border-white/10 rounded-xl mb-6 relative select-none layer-boost";
                const tabs = Object.keys(coreExercises);
                document.getElementById('modalTabs').innerHTML = tabs.map((t, i) => { const activeClass = "modal-active-tab flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out"; const inactiveClass = "text-slate-500 hover:text-slate-300 hover:bg-white/5 flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out"; return `<button onclick="switchCoreTab('${t}')" id="coreTab-${t}" class="${i === 0 ? activeClass : inactiveClass}">${t}</button>`; }).join('');
                switchCoreTab('Core');
            }
        }
        function switchCoreTab(tabName) {
            activeCoreTab = tabName; const tabs = Object.keys(coreExercises);
            const activeClass = "modal-active-tab flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out"; const inactiveClass = "text-slate-500 hover:text-slate-300 hover:bg-white/5 flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out";
            tabs.forEach(t => { document.getElementById(`coreTab-${t}`).className = (t === tabName) ? activeClass : inactiveClass; });
            renderExercises(coreExercises[tabName]);
        }
        function selectAbsLevel(level) { 
            if(!exerciseData[dateKey]) exerciseData[dateKey] = {}; if(!exerciseData[dateKey].absChoice) { exerciseData[dateKey].absChoice = level; saveData(); }
            absViewMode = 'workout'; activeAbsLevel = level; document.getElementById('modalDay').innerText = level.toUpperCase(); renderExercises(absLevels[level]); 
        }
        function closeModal() { document.getElementById('workoutModal').classList.add('hidden'); document.getElementById('workoutModal').classList.remove('flex'); if (isCoreMode && activeAbsLevel) { activeAbsLevel = null; } isLibraryMode = false; }
        function switchTab(i) { 
            currentTab = i; const w = workouts[dayName]; renderExercises(w.ex[currentTab]); const btns = document.getElementById('modalTabs').children; 
            const activeClass = "modal-active-tab flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out"; const inactiveClass = "text-slate-500 hover:text-slate-300 hover:bg-white/5 flex-1 py-3 rounded-lg text-sm font-black uppercase tracking-widest transition-all duration-300 ease-out";
            for(let b of btns) b.className = inactiveClass; btns[i].className = activeClass; 
        }
        function requestDelete(idx) { deleteIndex = idx; document.getElementById('deleteModal').classList.remove('hidden'); document.getElementById('deleteModal').classList.add('flex'); }
        function confirmDelete() { if(deleteIndex > -1) { weightHistory.splice(deleteIndex, 1); saveData(); refreshWeightUI(); } document.getElementById('deleteModal').classList.add('hidden'); document.getElementById('deleteModal').classList.remove('flex'); }

        init();
    </script>
</body>
</html>